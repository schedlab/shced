<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduler V1.9.4</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        body.rtl { font-family: 'Cairo', sans-serif; }
        .cursor-wait { cursor: wait; }
        .warnings-scroll::-webkit-scrollbar { width: 6px; }
        .warnings-scroll::-webkit-scrollbar-track { background: #fee2e2; }
        .warnings-scroll::-webkit-scrollbar-thumb { background: #ef4444; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .rtl .icon-flip { transform: scaleX(-1); }
        input[type="time"]::-webkit-calendar-picker-indicator { cursor: pointer; }
        /* Preview Styles */
        .excel-preview-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 rtl">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- TRANSLATIONS ---
        const TRANSLATIONS = {
            en: {
                title: "Scheduler V1.9.4",
                tabs: { schedule: "Schedule", availability: "Availability", employees: "Employees", settings: "Settings", export_opts: "Export Options" },
                months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                month_abbrs: ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"],
                actions: "Actions",
                pattern: "Pattern Logic",
                p22: "2 Work, 2 Rest",
                p21: "2 Work, 1 Rest",
                phybrid: "Hybrid 2-1 / 1-1",
                p211: "2 Work, 1 Standby, 1 Rest",
                generate: "Generate New",
                balancing: "Balancing...",
                clear: "Clear",
                save_data: "Save Data",
                load_data: "Load Data",
                export: "Export CSV",
                export_excel: "Export Excel",
                export_html: "Export Web View",
                stats: "Workload Stats",
                total: "Total",
                target: "Target Avg",
                shifts_person: "shifts/person",
                warnings: "Warnings",
                show_warnings: "Show Warnings",
                view_title: "Schedule View",
                highlight: "Highlight Employee...",
                morn: "Morning",
                eve: "Evening", 
                night: "Night",
                standby: "Standby",
                off: "Off",
                date_col: "Date",
                day: "Day",
                morn_col: "Morning Shift",
                eve_col: "Evening Shift", 
                night_col: "Night Shift",
                standby_col: "Standby Shift",
                off_col: "Off",
                avail_title: "Availability & Preferences",
                avail_desc: "Define hard constraints (Availability) and soft desires (Preferences).",
                emp_col: "Employee",
                pref_row: "Shift Preference",
                bulk_row: "Bulk Set",
                action_ph: "Action...",
                set_avail: "Set All Available",
                set_unavail: "Set All Unavailable",
                set_morn: "Set All Morning Only",
                set_eve: "Set All Evening Only",
                set_night: "Set All Night Only",
                set_standby: "Set All Standby Only",
                set_sun: "Prioritize Sundays",
                set_mon: "Prioritize Mondays",
                set_tue: "Prioritize Tuesdays",
                set_wed: "Prioritize Wednesdays",
                set_thu: "Prioritize Thursdays",
                set_fri: "Prioritize Fridays",
                set_sat: "Prioritize Saturdays",
                opt_unavail: "Unavail",
                opt_morn: "Morn Only",
                opt_eve: "Evening Only",
                opt_night: "Night Only",
                opt_standby: "Standby Only",
                opt_priority: "! Priority !",
                manage_staff: "Manage Staff list and Shift Rules in this tab.",
                add_staff: "Add Staff",
                confirm_clear: "Are you sure you want to clear the current schedule?",
                err_gen: "Error generating schedule.",
                issue_imbalance: "IMBALANCE: Shift gap is",
                issue_3day: "3-Day Work streak",
                issue_viol_streak: "VIOLATION: Has work streaks of 3 days!",
                issue_viol_rest: "VIOLATION: Rested 3+ days too many times!",
                days: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                start: "Start",
                end: "End",
                count: "Staff Count",
                settings_desc: "Configure shift times and staff requirements per day.",
                bulk_time_title: "Bulk Time Settings",
                bulk_time_desc: "Apply these times to all days of the week instantly.",
                apply_bulk: "Apply to All Days",
                enable_shifts: "Enable Optional Shifts",
                enable_night: "Enable Night Shift",
                enable_standby: "Enable Standby Shift",
                show_times: "Show Shift Times in Headers",
                to: "to",
                excel_settings_title: "Excel Customization",
                excel_settings_desc: "Customize the headers, footers, and images for your Excel export.",
                office_name: "Office/Dept Name (Top)",
                prepared_by: "Prepared By",
                header_color: "Header Row Color",
                header_text_color: "Header Text",
                text_color: "Text Color",
                header_weight: "Header Weight",
                body_weight: "Body Weight",
                weight_thin: "Thin",
                weight_extra_light: "Extra Light",
                weight_light: "Light",
                weight_normal: "Normal",
                weight_medium: "Medium",
                weight_semibold: "Semi-Bold",
                weight_bold: "Bold",
                weight_extra_bold: "Extra Bold",
                weight_black: "Black",
                font_size_header: "Header Size",
                font_size_body: "Body Size",
                header_image: "Header Image",
                footer_image: "Footer Image",
                upload_image: "Upload",
                remove_image: "Remove",
                preview_mode: "Preview how the file will look (Approximate)",
                border_weight: "Border Weight",
                thin: "Thin",
                medium: "Medium",
                thick: "Thick",
                double: "Double",
                effect: "Effect",
                ef_none: "Normal",
                ef_gray: "Grayscale",
                ef_wash: "Washout",
                ef_wash_gray: "Washout + Gray",
                use_watermark: "Use as Watermark (Background)",
                watermark_image: "Background Image (Watermark)",
                watermark_hint: "Check this to place the image BEHIND the data.",
                include_day_names: "Include day names in shift time cell",
                watermark_opacity: "Background Transparency",
                rest_of_data: "Rest of data...",
                mode_month: "Month Mode",
                mode_range: "Range Mode",
                date_start: "Start Date",
                date_end: "End Date",
                generated_in: "Generated in",
                cell_colors: "Cell Colors",
                morn_cell_color: "Morning Cell",
                eve_cell_color: "Evening Cell",
                night_cell_color: "Night Cell",
                standby_cell_color: "Standby Cell",
                off_cell_color: "Off Cell",
                date_col_color: "Date Column",
                header_row_color: "Shift Headers",
                view_settings: "View Settings",
                text_size_header: "Headers & Date Text Size",
                text_size_cell: "Schedule Names Text Size",
                border_thickness: "Border Thickness",
                frame_border: "Schedule Border Edges",
                frame_color: "Border Color",
                border_top: "Top",
                border_right: "Right",
                border_bottom: "Bottom",
                border_left: "Left",
                line_weight: "Grid Line Weight",
                line_color: "Grid Line Color",
                excel_border_settings: "Excel Border Styling",
                watermark_opacity: "Background Transparency",
                reset_view_styles: "Restore View Defaults",
                reset_excel_styles: "Restore Excel Defaults",
                rules_title: "Rules & Warnings",
                rules_desc: "Quick reminders about the scheduling logic and what triggers alerts.",
                rule_single_shift: "Each person can take only one work or standby assignment per day.",
                rule_unavailable: "Unavailable days will never be assigned.",
                rule_morning_only: "Morning-only keeps them off evening or night shifts.",
                rule_evening_only: "Evening-only keeps them off morning or night shifts.",
                rule_night_only: "Night-only keeps them off morning or evening shifts.",
                rule_standby_only: "Standby-only days limit them to standby assignments.",
                rule_priority: "Priority days get a stronger chance of assignment.",
                rule_standby: "Standby days block other shifts but still count toward rest tracking.",
                warning_rules_title: "Warning Triggers",
                warning_rules_desc: "These show up when balance or rest expectations are broken.",
                warning_unfilled: "Unfilled shifts are highlighted first—fill required slots immediately.",
                warning_imbalance: "Shift totals differ by more than 2 between staff.",
                warning_three_day: "Someone works 3 days straight.",
                warning_violation_streak: "A person accumulates multiple 3-day streaks.",
                warning_violation_rest: "A person rests 3+ days too many times.",
                warning_unfilled_detail: "UNFILLED: {shift} on {date} missing {count}"
            },
            ar: {
                title: "Scheduler V1.9.4",
                tabs: { schedule: "الجدول", availability: "التوافر", employees: "الموظفين", settings: "الإعدادات", export_opts: "تخصيص التصدير" },
                months: ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"],
                month_abbrs: ["ينا", "فبر", "مار", "أبر", "ماي", "يون", "يول", "أغس", "سبت", "أكت", "نوف", "ديس"],
                actions: "إجراءات",
                pattern: "نظام الورديات",
                p22: "2 عمل، 2 راحة",
                p21: "2 عمل، 1 راحة",
                phybrid: "هجين 2-1 / 1-1",
                p211: "2 عمل، 1 احتياط، 1 راحة",
                generate: "إنشاء جدول جديد",
                balancing: "جاري الموازنة...",
                clear: "مسح",
                save_data: "حفظ البيانات",
                load_data: "تحميل بيانات",
                export: "تصدير ملف CSV",
                export_excel: "تصدير ملف Excel",
                export_html: "تصدير صفحة ويب",
                stats: "إحصائيات العمل",
                total: "الإجمالي",
                target: "المعدل المستهدف",
                shifts_person: "وردية/شخص",
                warnings: "تنبيهات",
                show_warnings: "عرض التنبيهات",
                view_title: "عرض الجدول",
                highlight: "تظليل موظف...",
                morn: "صباحي",
                eve: "مسائي", 
                night: "ليلي",
                standby: "احتياط",
                off: "راحة",
                date_col: "التاريخ",
                day: "اليوم",
                morn_col: "الوردية الصباحية",
                eve_col: "الوردية المسائية", 
                night_col: "الوردية الليلية",
                standby_col: "الاحتياط",
                off_col: "راحة",
                avail_title: "التوافر والتفضيلات",
                avail_desc: "تحديد القيود الصارمة (التوافر) والرغبات المرنة (التفضيلات).",
                emp_col: "الموظف",
                pref_row: "تفضيل الوردية",
                bulk_row: "إجراء جماعي",
                action_ph: "اختر إجراء...",
                set_avail: "الكل متاح",
                set_unavail: "الكل غير متاح",
                set_morn: "الكل صباحي فقط",
                set_eve: "الكل مسائي فقط",
                set_night: "الكل ليلي فقط",
                set_standby: "الكل احتياط فقط",
                set_sun: "أولوية الأحد",
                set_mon: "أولوية الاثنين",
                set_tue: "أولوية الثلاثاء",
                set_wed: "أولوية الإربعاء",
                set_thu: "أولوية الخميس",
                set_fri: "أولوية الجمعة",
                set_sat: "أولوية السبت",
                opt_unavail: "غير متاح",
                opt_morn: "صباحي فقط",
                opt_eve: "مسائي فقط",
                opt_night: "ليلي فقط",
                opt_standby: "احتياط فقط",
                opt_priority: "! أولوية !",
                manage_staff: "إدارة قائمة الموظفين وقواعد الورديات في هذه العلامة.",
                add_staff: "إضافة موظف",
                confirm_clear: "هل أنت متأكد من رغبتك في مسح الجدول الحالي؟",
                err_gen: "حدث خطأ أثناء إنشاء الجدول.",
                issue_imbalance: "عدم توازن: فجوة الورديات هي",
                issue_3day: "سلسلة عمل 3 أيام",
                issue_viol_streak: "مخالفة: لديه سلاسل عمل لمدة 3 أيام!",
                issue_viol_rest: "مخالفة: ارتاح 3 أيام أو أكثر عدة مرات!",
                days: ['الأحد', 'الاثنين', 'الثلاثاء', 'الإربعاء', 'الخميس', 'الجمعة', 'السبت'],
                start: "بدء",
                end: "نهاية",
                count: "العدد المطلوب",
                settings_desc: "إعداد أوقات الورديات وعدد الموظفين لكل يوم.",
                bulk_time_title: "إعداد الوقت الجماعي",
                bulk_time_desc: "تطبيق هذه الأوقات على جميع أيام الأسبوع فوراً.",
                apply_bulk: "تطبيق على كل الأيام",
                enable_shifts: "تفعيل الورديات الإضافية",
                enable_night: "تفعيل الوردية الليلية",
                enable_standby: "تفعيل مناوبة الاحتياط",
                show_times: "إظهار أوقات الورديات في العناوين",
                to: "إلى",
                excel_settings_title: "تخصيص ملف الإكسل",
                excel_settings_desc: "تخصيص العناوين، التذييل، والصور لملف التصدير.",
                office_name: "اسم المكتب/القسم",
                prepared_by: "إعداد",
                header_color: "لون صف العناوين",
                header_text_color: "نص الترويسة",
                text_color: "لون النص",
                 header_weight: "سمك خط الترويسة",
                 body_weight: "سمك خط المحتوى",
                 weight_thin: "رفيع جداً",
                 weight_extra_light: "رفيع",
                 weight_light: "خفيف",
                 weight_normal: "عادي",
                 weight_medium: "متوسط",
                 weight_semibold: "نصف عريض",
                 weight_bold: "عريض",
                 weight_extra_bold: "عريض جداً",
                 weight_black: "ثقيل",
                font_size_header: "حجم خط العنوان",
                font_size_body: "حجم خط النص",
                header_image: "صورة الترويسة (Header)",
                footer_image: "صورة التذييل (Footer)",
                upload_image: "رفع صورة",
                remove_image: "إزالة",
                preview_mode: "معاينة تقريبية لشكل الملف",
                border_weight: "سمك الحدود",
                thin: "رفيع",
                medium: "متوسط",
                thick: "عريض",
                double: "مزدوج",
                effect: "المؤثرات",
                ef_none: "طبيعي",
                ef_gray: "أبيض وأسود",
                ef_wash: "باهت (Washout)",
                ef_wash_gray: "باهت + أبيض وأسود",
                use_watermark: "استخدام كعلامة مائية (خلفية)",
                watermark_image: "صورة الخلفية (علامة مائية)",
                 watermark_hint: "اجعل الصورة تظهر خلف البيانات (شفافة).",
                include_day_names: "عرض أسماء الأيام مع أوقات الورديات",
                 watermark_opacity: "شفافية الخلفية",
                rest_of_data: "باقي البيانات...",
                mode_month: "نظام الأشهر",
                mode_range: "نظام الفترة (تاريخ)",
                date_start: "تاريخ البدء",
                date_end: "تاريخ الانتهاء",
                generated_in: "تم إنشاؤه في",
                cell_colors: "ألوان الخلايا",
                morn_cell_color: "خلية الصباحي",
                eve_cell_color: "خلية المسائي",
                night_cell_color: "خلية الليلي",
                standby_cell_color: "خلية الاحتياط",
                off_cell_color: "خلية الراحة",
                date_col_color: "عمود التاريخ",
                header_row_color: "رأس الورديات",
                view_settings: "إعدادات العرض",
                text_size_header: "حجم خط العناوين والتاريخ",
                text_size_cell: "حجم خط أسماء الموظفين",
                border_thickness: "سمك الإطار",
                frame_border: "حواف صندوق الجدول",
                frame_color: "لون الحدود",
                border_top: "أعلى",
                border_right: "يمين",
                border_bottom: "أسفل",
                border_left: "يسار",
                line_weight: "سماكة خطوط الجدول",
                line_color: "لون خطوط الجدول",
                excel_border_settings: "تنسيق حدود ملف الإكسل",
                reset_view_styles: "استعادة تنسيقات العرض الافتراضية",
                reset_excel_styles: "استعادة تنسيقات الإكسل الافتراضية",
                rules_title: "القواعد والتنبيهات",
                rules_desc: "تذكير سريع بمنطق الجدولة وما الذي يسبب التنبيهات.",
                rule_single_shift: "شخص واحد لا يحصل إلا على نوبة عمل أو احتياط واحدة في اليوم.",
                rule_unavailable: "الأيام غير المتاحة لن تُكلّف أبداً.",
                rule_morning_only: "(صباح فقط) يمنع وضعه في النوبات المسائية أو الليلية.",
                rule_evening_only: "(مسائي فقط) يمنع وضعه في النوبات الصباحية أو الليلية.",
                rule_night_only: "(ليلي فقط) يمنع وضعه في النوبات الصباحية أو المسائية.",
                rule_standby_only: "(احتياط فقط) يقتصر تكليفه على مناوبة الاحتياط.",
                rule_priority: "الأيام ذات الأولوية تُمنح فرصة أكبر للتكليف.",
                rule_standby: "أيام الاحتياط تمنع النوبات الأخرى لكنها تُحسب ضمن تتبع الراحة.",
                warning_rules_title: "متى تظهر التحذيرات",
                warning_rules_desc: "تظهر عندما يختل التوازن أو تنكسر متطلبات الراحة.",
                warning_unfilled: "النوبات غير المغطاة تظهر أولاً — يرجى تعبئتها فوراً.",
                warning_imbalance: "إجمالي النوبات يختلف بأكثر من 2 بين الأفراد.",
                warning_three_day: "شخص يعمل 3 أيام متتالية.",
                warning_violation_streak: "شخص لديه أكثر من سلسلة عمل من 3 أيام.",
                warning_violation_rest: "شخص يرتاح 3 أيام أو أكثر لمرات كثيرة.",
                warning_unfilled_detail: "نقص تغطية: {shift} بتاريخ {date} ناقص {count}"
            }
        };

        const DEFAULT_VIEW_SETTINGS = {
            headerFontSize: 14,
            cellFontSize: 12,
            lineWeight: '1px',
            lineColor: '#e2e8f0',
            frameBorders: { top: '1px', right: '1px', bottom: '1px', left: '1px' },
            frameColor: '#e2e8f0'
        };

        const DEFAULT_EXCEL_CONFIG = {
            officeName: "",
            preparedBy: "",
            headerColor: "#db6fab",
            textColor: "#000000",
            headerFontSize: 18,
              headerFontWeight: 'extra_bold',
              bodyFontSize: 14,
              bodyFontWeight: 'bold',
            pageOrientation: 'portrait',
            fitToWidth: 1,
            fitToHeight: 1,
            paperSize: 9,
            centerHorizontally: true,
            centerVertically: true,
            pageMargins: { top: 0, right: 0, bottom: 0, left: 0, header: 0, footer: 0 },
              headerImage: null,
              footerImage: null,
              watermarkImage: null,
              headerEffect: 'none',
              footerEffect: 'none',
              watermarkEffect: 'washout',
              watermarkOpacity: 0.2,
              includeShiftDayNames: true,
            lineWeight: 'thin',
            lineColor: '#e2e8f0',
            frameBorders: { top: 'thin', right: 'thin', bottom: 'thin', left: 'thin' },
            frameColor: '#e2e8f0',
            mornCellColor: "#fef3c7",
            eveCellColor: "#e0e7ff",
            nightCellColor: "#f3e8ff",
            standbyCellColor: "#cffafe",
            offCellColor: "#f8fafc",
            headerRowColor: "#ffffff",
            dateColumnColor: "#ffffff",
        };

        // --- ICONS ---
        const IconWrapper = ({ children, className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>;
        const ChevronLeft = ({size, className}) => <IconWrapper className={`w-${size/4} h-${size/4} ${className || ''} icon-flip`}><polyline points="15 18 9 12 15 6"></polyline></IconWrapper>;
        const ChevronRight = ({size, className}) => <IconWrapper className={`w-${size/4} h-${size/4} ${className || ''} icon-flip`}><polyline points="9 18 15 12 9 6"></polyline></IconWrapper>;
        const RefreshCw = ({size}) => <IconWrapper className={`w-${size/4} h-${size/4}`}><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></IconWrapper>;
        const Download = ({size}) => <IconWrapper className={`w-${size/4} h-${size/4}`}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></IconWrapper>;
        const FileSpreadsheet = ({size}) => <IconWrapper className={`w-${size/4} h-${size/4}`}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="8" y1="13" x2="16" y2="13"></line><line x1="8" y1="17" x2="16" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></IconWrapper>;
        const Moon = ({size, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>;
        const Sun = ({size, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>;
        const AlertTriangle = ({size}) => <IconWrapper className={`w-${size/4} h-${size/4}`}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></IconWrapper>;
        const Users = ({size}) => <IconWrapper className={`w-${size/4} h-${size/4}`}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></IconWrapper>;
        const ArrowDownCircle = ({size}) => <IconWrapper className={`w-${size/4} h-${size/4}`}><circle cx="12" cy="12" r="10"></circle><polyline points="8 12 12 16 16 12"></polyline><line x1="12" y1="8" x2="12" y2="16"></line></IconWrapper>;
        const Trash2 = ({size}) => <IconWrapper className={`w-${size/4} h-${size/4}`}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconWrapper>;
        const Info = ({size, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>;
        const Eye = ({size, className}) => <IconWrapper className={`w-${size/4} h-${size/4} ${className || ''}`}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></IconWrapper>;
        const Globe = ({size}) => <IconWrapper className={`w-${size/4} h-${size/4}`}><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></IconWrapper>;
        const Clock = ({size, className}) => <IconWrapper className={`w-${size/4} h-${size/4} ${className || ''}`}><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></IconWrapper>;
        const Layers = ({size}) => <IconWrapper className={`w-${size/4} h-${size/4}`}><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></IconWrapper>;
        const Shield = ({size, className}) => <IconWrapper className={`w-${size/4} h-${size/4} ${className || ''}`}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></IconWrapper>;
        const Zap = ({size, className}) => <IconWrapper className={`w-${size/4} h-${size/4} ${className || ''}`}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></IconWrapper>;
        const Save = ({size}) => <IconWrapper className={`w-${size/4} h-${size/4}`}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></IconWrapper>;
        const Upload = ({size}) => <IconWrapper className={`w-${size/4} h-${size/4}`}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></IconWrapper>;
        const EyeOff = ({size, className}) => <IconWrapper className={`w-${size/4} h-${size/4} ${className || ''}`}><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></IconWrapper>;
        const SettingsIcon = ({size}) => <IconWrapper className={`w-${size/4} h-${size/4}`}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></IconWrapper>;
        const Image = ({size}) => <IconWrapper className={`w-${size/4} h-${size/4}`}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></IconWrapper>;
        const CalendarIcon = ({size}) => <IconWrapper className={`w-${size/4} h-${size/4}`}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></IconWrapper>;
        const Sliders = ({size}) => <IconWrapper className={`w-${size/4} h-${size/4}`}><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></IconWrapper>;

        // --- APP COMPONENT ---
        const ShiftScheduler = () => {
            // --- State ---
            const [currentDate, setCurrentDate] = useState(new Date());
            const [scheduleMode, setScheduleMode] = useState('month');
            const [rangeStart, setRangeStart] = useState(new Date().toISOString().split('T')[0]);
            const [rangeEnd, setRangeEnd] = useState(new Date(new Date().setDate(new Date().getDate() + 7)).toISOString().split('T')[0]);

            const [employees, setEmployees] = useState([
                { id: 1, name: 'إمحمد' },
                { id: 2, name: 'عمر' },
                { id: 3, name: 'أبو ستة' },
                { id: 4, name: 'جعودة' },
            ]);
            const [schedule, setSchedule] = useState({}); 
            
            const [enabledShifts, setEnabledShifts] = useState({ nightShift: false, standby: false });
            const [showShiftTimes, setShowShiftTimes] = useState(true);
            const [showWarnings, setShowWarnings] = useState(true);
            
            // --- NEW: View Settings State ---
            const [viewSettings, setViewSettings] = useState(() => ({ ...DEFAULT_VIEW_SETTINGS, frameBorders: { ...DEFAULT_VIEW_SETTINGS.frameBorders } }));

            // EXCEL CUSTOMIZATION STATE
            const [excelConfig, setExcelConfig] = useState(() => ({ ...DEFAULT_EXCEL_CONFIG, frameBorders: { ...DEFAULT_EXCEL_CONFIG.frameBorders } }));

            const createDefaultDay = () => ({
                morning: 1, night: 1, nightShift: 1, standby: 1,
                morningStart: "08:00", morningEnd: "15:00",
                nightStart: "15:00", nightEnd: "21:00",
                nightShiftStart: "21:00", nightShiftEnd: "08:00",
                standbyStart: "00:00", standbyEnd: "23:59" 
            });

            const defaultRequirements = {
                0: createDefaultDay(), 1: createDefaultDay(), 2: createDefaultDay(),
                3: createDefaultDay(), 4: createDefaultDay(), 5: createDefaultDay(), 6: createDefaultDay()
            };
            
            defaultRequirements[5].morning = 0; 
            defaultRequirements[6].morning = 1;

            const [requirements, setRequirements] = useState(defaultRequirements);
            const [activeTab, setActiveTab] = useState('schedule'); 
            const [patternType, setPatternType] = useState('hybrid'); 
            const [availability, setAvailability] = useState({}); 
            const [preferences, setPreferences] = useState({}); 
            const [isGenerating, setIsGenerating] = useState(false);
            const [bulkSelectState, setBulkSelectState] = useState({});
            const [highlightedEmp, setHighlightedEmp] = useState('');
            
            const [bulkMStart, setBulkMStart] = useState("08:00");
            const [bulkMEnd, setBulkMEnd] = useState("15:00");
            const [bulkNStart, setBulkNStart] = useState("15:00");
            const [bulkNEnd, setBulkNEnd] = useState("21:00");
            const [bulkNSStart, setBulkNSStart] = useState("21:00"); 
            const [bulkNSEnd, setBulkNSEnd] = useState("08:00"); 
            
            const [lang, setLang] = useState('ar'); 
            const t = (key) => TRANSLATIONS[lang][key] || key;
            const fileInputRef = useRef(null);
            const headerImgRef = useRef(null);
            const footerImgRef = useRef(null);
            const watermarkImgRef = useRef(null);

            const normalizeViewSettings = (settings) => {
                if (!settings) return null;
                const normalized = { ...DEFAULT_VIEW_SETTINGS, ...settings };
                if (!normalized.headerFontSize) normalized.headerFontSize = normalized.fontSize || DEFAULT_VIEW_SETTINGS.headerFontSize;
                if (!normalized.cellFontSize) normalized.cellFontSize = normalized.fontSize || DEFAULT_VIEW_SETTINGS.cellFontSize;
                if (!normalized.lineWeight) normalized.lineWeight = normalized.borderWidth || DEFAULT_VIEW_SETTINGS.lineWeight;
                if (!normalized.lineColor) normalized.lineColor = DEFAULT_VIEW_SETTINGS.lineColor;
                if (!normalized.frameBorders) {
                    const inherited = normalized.borderWidth || normalized.lineWeight || DEFAULT_VIEW_SETTINGS.lineWeight;
                    normalized.frameBorders = { top: inherited, right: inherited, bottom: inherited, left: inherited };
                }
                if (!normalized.frameColor) normalized.frameColor = normalized.lineColor || DEFAULT_VIEW_SETTINGS.frameColor;
                return normalized;
            };

            const mergeRequirements = (incomingRequirements) => {
                const mergedReqs = { ...defaultRequirements };
                if (incomingRequirements) {
                    Object.keys(incomingRequirements).forEach(key => {
                        mergedReqs[key] = { ...mergedReqs[key], ...incomingRequirements[key] };
                    });
                }
                return mergedReqs;
            };

            const sanitizeExcelConfig = (config) => {
                if (!config) return null;
                const sanitized = { ...DEFAULT_EXCEL_CONFIG, ...config };
                delete sanitized.backgroundImage;
                delete sanitized.useWatermark;
                delete sanitized.headerImageAlign;
                delete sanitized.footerImageAlign;
                delete sanitized.borderWeight;

                if (!['washout','washout_grayscale'].includes(sanitized.watermarkEffect)) sanitized.watermarkEffect = 'washout';
                  const allowedWeights = ['thin','extra_light','light','normal','medium','semibold','bold','extra_bold','black'];
                  if (!allowedWeights.includes(sanitized.headerFontWeight)) sanitized.headerFontWeight = 'normal';
                  if (!allowedWeights.includes(sanitized.bodyFontWeight)) sanitized.bodyFontWeight = 'normal';
                  sanitized.headerFontSize = Math.max(8, Math.min(48, Number(sanitized.headerFontSize) || 14));
                  sanitized.bodyFontSize = Math.max(8, Math.min(48, Number(sanitized.bodyFontSize) || 14));
                  sanitized.watermarkOpacity = Math.max(0.05, Math.min(1, Number(sanitized.watermarkOpacity ?? DEFAULT_EXCEL_CONFIG.watermarkOpacity) || DEFAULT_EXCEL_CONFIG.watermarkOpacity));
                sanitized.pageOrientation = 'portrait';
                sanitized.centerHorizontally = true;
                sanitized.centerVertically = true;
                const parseFitValue = (val, fallback) => {
                    const num = Number(val);
                    return Number.isFinite(num) && num >= 1 ? num : fallback;
                };
                sanitized.fitToWidth = parseFitValue(sanitized.fitToWidth, DEFAULT_EXCEL_CONFIG.fitToWidth);
                sanitized.fitToHeight = parseFitValue(sanitized.fitToHeight, DEFAULT_EXCEL_CONFIG.fitToHeight);
                const normalizePaperSize = (val) => {
                    if (typeof val === 'string' && val.toLowerCase() === 'a4') return 9;
                    const num = Number(val);
                    return Number.isFinite(num) && num > 0 ? num : DEFAULT_EXCEL_CONFIG.paperSize;
                };
                sanitized.paperSize = normalizePaperSize(sanitized.paperSize);
                const defaultMargins = DEFAULT_EXCEL_CONFIG.pageMargins;
                sanitized.pageMargins = { ...defaultMargins };

                sanitized.includeShiftDayNames = sanitized.includeShiftDayNames !== false;

                const allowedLineWeights = ['thin','medium','thick'];
                if (config?.borderWeight && allowedLineWeights.includes(config.borderWeight)) {
                    sanitized.lineWeight = config.borderWeight;
                    if (!config.frameBorders) sanitized.frameBorders = { top: config.borderWeight, right: config.borderWeight, bottom: config.borderWeight, left: config.borderWeight };
                }
                if (!allowedLineWeights.includes(sanitized.lineWeight)) sanitized.lineWeight = DEFAULT_EXCEL_CONFIG.lineWeight;
                sanitized.lineColor = sanitized.lineColor || DEFAULT_EXCEL_CONFIG.lineColor;

                sanitized.frameBorders = sanitized.frameBorders ? { ...DEFAULT_EXCEL_CONFIG.frameBorders, ...sanitized.frameBorders } : { ...DEFAULT_EXCEL_CONFIG.frameBorders };
                Object.keys(sanitized.frameBorders).forEach(side => {
                    if (!allowedLineWeights.includes(sanitized.frameBorders[side])) sanitized.frameBorders[side] = sanitized.lineWeight;
                });
                sanitized.frameColor = sanitized.frameColor || sanitized.lineColor;
                return sanitized;
            };

            const applyLoadedData = (data) => {
                if (!data) return;
                setEmployees(data.employees || employees);
                setSchedule(data.schedule || {});
                setEnabledShifts(data.enabledShifts || { nightShift: false, standby: false });
                if (data.showShiftTimes !== undefined) setShowShiftTimes(data.showShiftTimes);
                if (data.showWarnings !== undefined) setShowWarnings(data.showWarnings);
                if (data.scheduleMode) setScheduleMode(data.scheduleMode);
                if (data.rangeStart) setRangeStart(data.rangeStart);
                if (data.rangeEnd) setRangeEnd(data.rangeEnd);

                const normalizedView = normalizeViewSettings(data.viewSettings);
                if (normalizedView) setViewSettings(normalizedView);

                setRequirements(mergeRequirements(data.requirements));
                setAvailability(data.availability || {});
                setPreferences(data.preferences || {});
                if (data.lang) setLang(data.lang);

                const sanitizedExcel = sanitizeExcelConfig(data.excelConfig);
                if (sanitizedExcel) setExcelConfig(sanitizedExcel);
            };

            const resetViewStyles = () => setViewSettings({ ...DEFAULT_VIEW_SETTINGS, frameBorders: { ...DEFAULT_VIEW_SETTINGS.frameBorders } });

            const resetExcelStyles = () => setExcelConfig(prev => ({
                ...DEFAULT_EXCEL_CONFIG,
                frameBorders: { ...DEFAULT_EXCEL_CONFIG.frameBorders },
                officeName: prev.officeName,
                preparedBy: prev.preparedBy,
                headerImage: prev.headerImage,
                footerImage: prev.footerImage,
                watermarkImage: prev.watermarkImage,
            }));

            // --- Effects ---
            useEffect(() => {
                try {
                    const saved = localStorage.getItem('scheduler_data_v1_9_3');
                    if (saved) {
                        applyLoadedData(JSON.parse(saved));
                    }
                } catch (e) { console.error("Load failed", e); }
            }, []);

            useEffect(() => {
                document.body.dir = lang === 'ar' ? 'rtl' : 'ltr';
                document.body.className = lang === 'ar' ? 'bg-slate-50 text-slate-900 rtl' : 'bg-slate-50 text-slate-900 ltr';
                
                try {
                    localStorage.setItem('scheduler_data_v1_9_3', JSON.stringify({
                        employees, schedule, requirements, availability, preferences, lang, enabledShifts, showShiftTimes, excelConfig,
                        showWarnings, scheduleMode, rangeStart, rangeEnd, viewSettings
                    }));
                } catch (e) {}
            }, [employees, schedule, requirements, availability, preferences, lang, enabledShifts, showShiftTimes, excelConfig, showWarnings, scheduleMode, rangeStart, rangeEnd, viewSettings]);

            // ... (helper methods)
            const clearSchedule = () => {
                if(window.confirm(t('confirm_clear'))) {
                    setSchedule({});
                }
            };
            
            const handleToggleOptionalShift = (shiftKey, isEnabled) => {
                setEnabledShifts(prev => ({...prev, [shiftKey]: isEnabled}));
                if (isEnabled) {
                    const newReqs = { ...requirements };
                    let changed = false;
                    Object.keys(newReqs).forEach(key => {
                        if (newReqs[key][shiftKey] === 0) {
                             newReqs[key][shiftKey] = 1;
                             changed = true;
                        }
                    });
                    if (changed) setRequirements(newReqs);
                } else {
                    if (shiftKey === 'nightShift' || shiftKey === 'standby') {
                        setAvailability(prev => {
                            const updated = { ...prev };
                            Object.keys(updated).forEach(empId => {
                                const days = { ...updated[empId] };
                                Object.keys(days).forEach(dateKey => {
                                    if ((shiftKey === 'nightShift' && days[dateKey] === 'night_only') || (shiftKey === 'standby' && days[dateKey] === 'standby_only')) {
                                        delete days[dateKey];
                                    }
                                });
                                updated[empId] = days;
                            });
                            return updated;
                        });
                    }
                }
            };

            const applyBulkTimes = () => {
                const newReqs = { ...requirements };
                Object.keys(newReqs).forEach(key => {
                    newReqs[key] = {
                        ...newReqs[key],
                        morningStart: bulkMStart,
                        morningEnd: bulkMEnd,
                        nightStart: bulkNStart,
                        nightEnd: bulkNEnd,
                        nightShiftStart: bulkNSStart, 
                        nightShiftEnd: bulkNSEnd
                    };
                });
                setRequirements(newReqs);
                alert("Times updated for all days!");
            };

            const getCalculatedDays = () => {
                if (scheduleMode === 'range') {
                    const start = new Date(rangeStart);
                    const end = new Date(rangeEnd);
                    const days = [];
                    if (isNaN(start) || isNaN(end) || start > end) return [];
                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        days.push(new Date(d));
                    }
                    return days;
                } else {
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    const days = new Date(year, month + 1, 0).getDate();
                    const result = [];
                    for (let i = 1; i <= days; i++) {
                        result.push(new Date(year, month, i));
                    }
                    return result;
                }
            };

            const formatDateKey = (date) => date.toISOString().split('T')[0];
            const getDayName = (date) => {
                const dayIdx = date.getDay();
                return TRANSLATIONS[lang].days[dayIdx];
            };

            const formatShortDate = (date) => {
                const months = TRANSLATIONS[lang].months || TRANSLATIONS['en'].months;
                const month = months[date.getMonth()];
                const day = String(date.getDate()).padStart(2, '0');
                return `${month} ${day}`;
            };

            const formatTime12 = (time24) => {
                if (!time24) return "";
                let [h, m] = time24.split(':');
                h = parseInt(h);
                const isPm = h >= 12;
                h = h % 12;
                h = h ? h : 12; 
                const suffix = isPm ? (lang === 'ar' ? 'م' : 'PM') : (lang === 'ar' ? 'ص' : 'AM');
                return `${h}:${m} ${suffix}`;
            };

            const saveData = () => {
                const data = {
                    employees, schedule, requirements, availability, preferences, lang, enabledShifts, showShiftTimes, excelConfig,
                    showWarnings, scheduleMode, rangeStart, rangeEnd, viewSettings,
                    version: "1.9.4",
                    timestamp: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
                saveAs(blob, `scheduler_backup_${new Date().toISOString().split('T')[0]}.json`);
            };

            const triggerLoad = () => fileInputRef.current.click();

            const loadData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        applyLoadedData(data);
                        alert("Data loaded successfully!");
                    } catch (err) {
                        console.error(err);
                        alert("Error loading file.");
                    }
                };
                reader.readAsText(file);
                e.target.value = null; 
            };

            const toggleLanguage = () => {
                setLang(prev => prev === 'en' ? 'ar' : 'en');
            };

            const getShiftTimeSummary = (shiftKey, options = {}) => {
                if (!showShiftTimes) return [];
                if (shiftKey === 'standby') return [];

                const includeDayNames = options.includeDayNames !== false;

                const groups = {};
                for(let i=0; i<7; i++) {
                    const req = requirements[i];
                    if (!req[shiftKey] || req[shiftKey] === 0) continue;
                    const s = req[`${shiftKey}Start`];
                    const e = req[`${shiftKey}End`];
                    if(!s || !e) continue; 
                    const timeStr = `${formatTime12(s)} - ${formatTime12(e)}`;
                    if(!groups[timeStr]) groups[timeStr] = [];
                    groups[timeStr].push(i);
                }

                const results = [];
                Object.entries(groups).forEach(([time, dayIndices]) => {
                    if (dayIndices.length === 7) {
                        results.push({ label: '', time });
                        return;
                    }
                    const order = [6, 0, 1, 2, 3, 4, 5]; 
                    const sorted = dayIndices.sort((a,b) => order.indexOf(a) - order.indexOf(b));
                    let ranges = [];
                    let startIdx = 0;
                    while(startIdx < sorted.length) {
                        let endIdx = startIdx;
                        while (
                            endIdx + 1 < sorted.length && 
                            order.indexOf(sorted[endIdx+1]) === order.indexOf(sorted[endIdx]) + 1
                        ) {
                            endIdx++;
                        }
                        const startDay = TRANSLATIONS[lang].days[sorted[startIdx]];
                        if (startIdx === endIdx) {
                            ranges.push(startDay);
                        } else {
                            const endDay = TRANSLATIONS[lang].days[sorted[endIdx]];
                            ranges.push(`${startDay} ${t('to')} ${endDay}`);
                        }
                        startIdx = endIdx + 1;
                    }
                    results.push({ label: ranges.join(', '), time });
                });
                return results.map(r => {
                    const timeValue = lang === 'ar' ? `\u202B${r.time}\u202C` : r.time;
                    if (!includeDayNames || !r.label.trim()) return timeValue;
                    return `${r.label} ${timeValue}`.trim();
                });
            };

            // --- IMAGE HANDLER ---
            const handleHeaderImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => { setExcelConfig(prev => ({ ...prev, headerImage: reader.result })); };
                    reader.readAsDataURL(file);
                }
            };
            const handleFooterImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => { setExcelConfig(prev => ({ ...prev, footerImage: reader.result })); };
                    reader.readAsDataURL(file);
                }
            };
            const handleWatermarkImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => { setExcelConfig(prev => ({ ...prev, watermarkImage: reader.result })); };
                    reader.readAsDataURL(file);
                }
            };
            
            const getImageDimensions = (base64Str) => {
                return new Promise((resolve) => {
                    if (!base64Str) { resolve({ width: 0, height: 0 }); return; }
                    const img = document.createElement('img');
                    img.onload = () => { resolve({ width: img.width, height: img.height }); };
                    img.onerror = () => { resolve({ width: 0, height: 0 }); };
                    img.src = base64Str;
                });
            };

            const hexToArgb = (hex) => {
                let c = hex.substring(1);
                if (c.length === 3) c = c.split('').map(x=>x+x).join('');
                return 'FF' + c.toUpperCase();
            };

              const weightValue = (weight) => {
                  const map = {
                      thin: 100,
                      extra_light: 200,
                      light: 300,
                      normal: 400,
                      medium: 500,
                      semibold: 600,
                      bold: 700,
                      extra_bold: 800,
                      black: 900
                  };
                  return map[weight] || 400;
              };

            const isBoldWeight = (weight) => weightValue(weight) >= 600;

            const lineWeightToPx = (weight) => {
                if (weight === 'medium') return '2px';
                if (weight === 'thick') return '3px';
                return '1px';
            };

            // --- EXPORT FUNCTIONS ---
            const exportCSV = () => {
                const days = getCalculatedDays();
                let mSummary = "";
                let nSummary = "";
                let nsSummary = "";

                if (showShiftTimes) {
                     mSummary = " [" + getShiftTimeSummary('morning').join(' | ') + "]";
                     nSummary = " [" + getShiftTimeSummary('night').join(' | ') + "]";
                     nsSummary = " [" + getShiftTimeSummary('nightShift').join(' | ') + "]";
                }
                
                let header = `${t('date_col')},${t('day')}`;
                header += `,${t('morn_col')}${mSummary}`;
                header += `,${t('eve_col')}${nSummary}`;
                if(enabledShifts.nightShift) header += `,${t('night_col')}${nsSummary}`;
                if(enabledShifts.standby) header += `,${t('standby_col')}`;
                header += `,${t('off_col')}\n`;

                let csv = `\uFEFF${header}`; 
                days.forEach(day => {
                    const dKey = formatDateKey(day);
                    const niceDate = formatShortDate(day);
                    const s = schedule[dKey] || { morning: [], night: [], nightShift: [], standby: [] };
                    
                    const m = s.morning.map(id => employees.find(e => e.id === id)?.name).join(' / ');
                    const n = s.night.map(id => employees.find(e => e.id === id)?.name).join(' / ');
                    const ns = (s.nightShift || []).map(id => employees.find(e => e.id === id)?.name).join(' / ');
                    const sb = (s.standby || []).map(id => employees.find(e => e.id === id)?.name).join(' / ');
                    
                    let workers = [...s.morning, ...s.night];
                    if(enabledShifts.nightShift) workers = [...workers, ...(s.nightShift || [])];
                    const off = employees.filter(e => !workers.includes(e.id) && !(s.standby || []).includes(e.id)).map(e => e.name).join(' / ');

                    let row = `${niceDate},${getDayName(day)},"${m}","${n}"`;
                    if(enabledShifts.nightShift) row += `,"${ns}"`;
                    if(enabledShifts.standby) row += `,"${sb}"`; 
                    row += `,"${off}"\n`;
                    csv += row;
                });
                const link = document.createElement("a");
                link.href = encodeURI("data:text/csv;charset=utf-8," + csv);
                link.download = `Schedule_Export.csv`;
                link.click();
            };

             const processImageEffect = async (base64Str, effect, opacityOverride) => {
                   if (!base64Str || effect === 'none') return base64Str;
                   return new Promise((resolve) => {
                       const img = document.createElement('img');
                       img.onload = () => {
                           const canvas = document.createElement('canvas');
                           canvas.width = img.width;
                           canvas.height = img.height;
                           const ctx = canvas.getContext('2d');
                           const baseOpacity = (effect === 'washout' || effect === 'washout_grayscale') ? 0.35 : 1;
                           const opacity = Math.max(0, Math.min(1, opacityOverride ?? baseOpacity));
                           let filter = '';
                           if(effect === 'grayscale') filter = 'grayscale(100%)';
                           else if(effect === 'washout') filter = `opacity(${opacity}) brightness(1.2) contrast(0.8)`;
                           else if(effect === 'washout_grayscale') filter = `grayscale(100%) opacity(${opacity}) brightness(1.2) contrast(0.8)`;
                           else filter = `opacity(${opacity})`;
                           ctx.filter = filter;
                           ctx.drawImage(img, 0, 0);
                           resolve(canvas.toDataURL('image/png'));
                       };
                     img.src = base64Str;
                 });
            };

            const exportExcel = async () => {
                if (!window.ExcelJS) {
                    alert("Excel library not loaded. Please refresh.");
                    return;
                }

                const isRtl = lang === 'ar';
                const workbook = new ExcelJS.Workbook();
                const sheet = workbook.addWorksheet('Schedule', {
                    views: [{ rightToLeft: isRtl }]
                });

                const baseMargins = excelConfig.pageMargins || DEFAULT_EXCEL_CONFIG.pageMargins;
                const directionalMargins = { top: 0.2, bottom: 0.2, left: isRtl ? 0 : 0.3, right: isRtl ? 0.3 : 0 };
                const pageMargins = { ...baseMargins, ...directionalMargins };
                sheet.pageSetup = {
                    orientation: 'portrait',
                    horizontalCentered: true,
                    verticalCentered: true,
                    fitToPage: true,
                    fitToWidth: Number(excelConfig.fitToWidth ?? DEFAULT_EXCEL_CONFIG.fitToWidth),
                    fitToHeight: Number(excelConfig.fitToHeight ?? DEFAULT_EXCEL_CONFIG.fitToHeight),
                    margins: pageMargins,
                    paperSize: Number(excelConfig.paperSize ?? DEFAULT_EXCEL_CONFIG.paperSize)
                };

                const days = getCalculatedDays();
                const hasTitle = !!excelConfig.officeName;
                const hasFooter = !!excelConfig.preparedBy;
                let dateTitle = '';
                if (scheduleMode === 'month') {
                    dateTitle = `${TRANSLATIONS[lang].months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
                } else {
                    const startDate = new Date(rangeStart);
                    const endDate = new Date(rangeEnd);
                    if (!isNaN(startDate) && !isNaN(endDate)) {
                        dateTitle = `${formatShortDate(startDate)} ${t('to')} ${formatShortDate(endDate)}`;
                    }
                }

                const baseDateWidth = 18;
                const baseDayWidth = 12;
                const baseShiftWidth = 35;
                const totalShiftColumnsIfAllEnabled = 5; // morning, evening, night, standby, off
                let columns = [
                    { header: t('date_col'), key: 'date', width: baseDateWidth },
                    { header: t('day'), key: 'day', width: baseDayWidth },
                    { header: t('morn_col'), key: 'morning', width: baseShiftWidth },
                    { header: t('eve_col'), key: 'night', width: baseShiftWidth }
                ];
                if(enabledShifts.nightShift) columns.push({ header: t('night_col'), key: 'nightShift', width: baseShiftWidth });
                if(enabledShifts.standby) columns.push({ header: t('standby_col'), key: 'standby', width: baseShiftWidth });
                columns.push({ header: t('off_col'), key: 'off', width: baseShiftWidth });

                const totalDesiredWidth = baseDateWidth + baseDayWidth + (baseShiftWidth * totalShiftColumnsIfAllEnabled);
                const currentTotalWidth = columns.reduce((sum, col) => sum + (col.width || baseShiftWidth), 0);
                const extraPerColumn = columns.length
                    ? Math.max(0, totalDesiredWidth - currentTotalWidth) / columns.length
                    : 0;

                const hideShiftHeader = (key) => ['morning','night','nightShift'].includes(key);
                columns = columns.map(col => {
                    const baseWidth = (col.width || baseShiftWidth) + extraPerColumn;
                    return hideShiftHeader(col.key) ? { ...col, header: '', width: baseWidth } : { ...col, width: baseWidth };
                });

                const totalCols = columns.length;
                const lastColChar = String.fromCharCode(64 + totalCols);
                
                const headerArgb = hexToArgb(excelConfig.headerColor);
                const textArgb = hexToArgb(excelConfig.textColor);
                const headerWeightVal = weightValue(excelConfig.headerFontWeight);
                const bodyWeightVal = weightValue(excelConfig.bodyFontWeight);

                const lineStyle = excelConfig.lineWeight || 'thin';
                const lineColorArgb = hexToArgb(excelConfig.lineColor || '#e2e8f0');
                const frameColorArgb = hexToArgb(excelConfig.frameColor || excelConfig.lineColor || '#e2e8f0');
                const frameBorders = excelConfig.frameBorders || DEFAULT_EXCEL_CONFIG.frameBorders;

                const buildBorder = ({ isFirstRow, isLastRow, isFirstCol, isLastCol }) => ({
                    top: { style: isFirstRow ? frameBorders.top : lineStyle, color: { argb: isFirstRow ? frameColorArgb : lineColorArgb } },
                    left: { style: isFirstCol ? frameBorders.left : lineStyle, color: { argb: isFirstCol ? frameColorArgb : lineColorArgb } },
                    bottom: { style: isLastRow ? frameBorders.bottom : lineStyle, color: { argb: isLastRow ? frameColorArgb : lineColorArgb } },
                    right: { style: isLastCol ? frameBorders.right : lineStyle, color: { argb: isLastCol ? frameColorArgb : lineColorArgb } },
                });

                const headerFont = { color: { argb: headerArgb }, bold: headerWeightVal >= 600, size: excelConfig.headerFontSize, name: lang === 'ar' ? 'Cairo' : 'Calibri' };
                const pinkBoldFont = { name: lang === 'ar' ? 'Cairo' : 'Calibri', size: excelConfig.bodyFontSize, bold: headerWeightVal >= 600, color: { argb: headerArgb } };
                const defaultFont = { name: lang === 'ar' ? 'Cairo' : 'Calibri', size: excelConfig.bodyFontSize, bold: bodyWeightVal >= 600, color: { argb: textArgb } };

                const centerAlign = { vertical: 'middle', horizontal: 'center', wrapText: true };
                // Alignment for date/day column
                const dateAlign = { vertical: 'middle', horizontal: 'center', wrapText: true };

                // --- 1. SET UP COLUMNS ---
                sheet.columns = columns; 
                let currentRow = 1;

                // --- 2. HEADER LOGO ---
                if (excelConfig.headerImage) {
                    const finalHeaderImgStr = await processImageEffect(excelConfig.headerImage, excelConfig.headerEffect);
                    const { width: imgWidth, height: imgHeight } = await getImageDimensions(finalHeaderImgStr);
                    const imageId = workbook.addImage({
                        base64: finalHeaderImgStr,
                        extension: 'png',
                    });
                    
                    sheet.insertRow(1, {});
                    sheet.mergeCells(`A1:${lastColChar}1`);
                    const headerRow = sheet.getRow(1);
                    headerRow.height = 100;
                    
                    if (imgWidth > 0 && imgHeight > 0) {
                        const targetHeight = 120;
                        const targetWidth = (imgWidth / imgHeight) * targetHeight;
                        const tlCol = Math.max(0, (totalCols / 2) - 1);
                        sheet.addImage(imageId, {
                            tl: { col: tlCol, row: 0.1 },
                            ext: { width: targetWidth, height: targetHeight },
                            editAs: 'absolute'
                        });
                    }
                    currentRow++;
                }

                // --- 3. OFFICE NAME (TITLE) ---
                if (hasTitle) {
                    sheet.insertRow(currentRow, {});
                    sheet.mergeCells(`A${currentRow}:${lastColChar}${currentRow}`);
                    const titleCell = sheet.getCell(`A${currentRow}`);
                    titleCell.value = excelConfig.officeName;
                    titleCell.font = { ...headerFont, size: excelConfig.headerFontSize + 4 };
                    titleCell.alignment = centerAlign;
                    sheet.getRow(currentRow).height = 40;
                    currentRow++;
                }

                if (dateTitle) {
                    sheet.insertRow(currentRow, {});
                    sheet.mergeCells(`A${currentRow}:${lastColChar}${currentRow}`);
                    const dateCell = sheet.getCell(`A${currentRow}`);
                    dateCell.value = dateTitle;
                    dateCell.font = { ...defaultFont, bold: true, size: excelConfig.bodyFontSize + 1 };
                    dateCell.alignment = centerAlign;
                    sheet.getRow(currentRow).height = 26;
                    currentRow++;
                }

                // --- 4. HEADERS (The actual table headers) ---
                const headerRow = sheet.getRow(currentRow);

                columns.forEach((col, idx) => {
                    const isShiftHeader = ['morning','night','nightShift'].includes(col.key);
                    let val = isShiftHeader ? '' : col.header;
                    if (showShiftTimes) {
                        const summary = col.key === 'morning' ? getShiftTimeSummary('morning', { includeDayNames: excelConfig.includeShiftDayNames !== false })
                            : col.key === 'night' ? getShiftTimeSummary('night', { includeDayNames: excelConfig.includeShiftDayNames !== false })
                            : col.key === 'nightShift' ? getShiftTimeSummary('nightShift', { includeDayNames: excelConfig.includeShiftDayNames !== false })
                            : [];
                        if (summary.length) {
                            val = val ? `${val}\n${summary.join('\n')}` : summary.join('\n');
                        }
                    }
                    headerRow.getCell(idx + 1).value = val;
                });

                const dataRowHeight = 45;
                headerRow.height = showShiftTimes ? dataRowHeight * 2 : dataRowHeight;
                headerRow.eachCell((cell, colNumber) => {
                    cell.font = headerFont;
                    cell.alignment = centerAlign;
                    cell.border = buildBorder({
                        isFirstRow: true,
                        isLastRow: days.length === 0,
                        isFirstCol: colNumber === 1,
                        isLastCol: colNumber === totalCols
                    });
                    // Apply header row color background
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: hexToArgb(excelConfig.headerRowColor) } };
                });

                // --- 5. DATA ROWS ---
                days.forEach((day, dayIdx) => {
                    const dKey = formatDateKey(day);
                    const niceDate = formatShortDate(day);
                    const s = schedule[dKey] || { morning: [], night: [], nightShift: [], standby: [] };

                    const getNames = (arr) => (arr || []).map(id => employees.find(e => e.id === id)?.name).join(' / ');
                    let workers = [...s.morning, ...s.night];
                    if(enabledShifts.nightShift) workers = [...workers, ...(s.nightShift || [])];
                    const offNames = employees.filter(e => !workers.includes(e.id) && !(s.standby || []).includes(e.id)).map(e => e.name).join(' / ');
                    
                    const rowData = {};
                    rowData['date'] = niceDate;
                    rowData['day'] = getDayName(day);
                    rowData['morning'] = getNames(s.morning) || '-';
                    rowData['night'] = getNames(s.night) || '-';
                    if(enabledShifts.nightShift) rowData['nightShift'] = getNames(s.nightShift) || '-';
                    if(enabledShifts.standby) rowData['standby'] = getNames(s.standby) || '-';
                    rowData['off'] = offNames;

                    const row = sheet.addRow(rowData);
                    row.height = dataRowHeight;
                    
                    row.eachCell((cell, colNumber) => {
                        // FIX: Use column key to determine color
                        const colKey = sheet.getColumn(colNumber).key;
                        let fill = null;
                        
                        if (colKey === 'date' || colKey === 'day') {
                            fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: hexToArgb(excelConfig.dateColumnColor) } };
                            cell.alignment = dateAlign; // Fix alignment here
                        }
                        else if (colKey === 'morning') fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: hexToArgb(excelConfig.mornCellColor) } };
                        else if (colKey === 'night') fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: hexToArgb(excelConfig.eveCellColor) } };
                        else if (colKey === 'nightShift') fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: hexToArgb(excelConfig.nightCellColor) } };
                        else if (colKey === 'standby') fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: hexToArgb(excelConfig.standbyCellColor) } };
                        else if (colKey === 'off') fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: hexToArgb(excelConfig.offCellColor) } };
                        
                        if(fill) cell.fill = fill;

                        if (colKey !== 'date' && colKey !== 'day') {
                           if (colNumber <= 2) cell.font = pinkBoldFont;
                           else cell.font = defaultFont;
                           cell.alignment = centerAlign;
                        } else {
                            cell.font = { ...defaultFont, color: { argb: headerArgb }, bold: isBoldWeight(excelConfig.headerFontWeight) };
                            cell.alignment = dateAlign;
                        }
                        cell.border = buildBorder({
                            isFirstRow: false,
                            isLastRow: dayIdx === days.length - 1,
                            isFirstCol: colNumber === 1,
                            isLastCol: colNumber === totalCols
                        });
                    });
                });

                // --- 6. FOOTER (PREPARED BY) ---
                if (hasFooter) {
                    const footerRowIdx = sheet.rowCount + 1;
                    sheet.mergeCells(`A${footerRowIdx}:${lastColChar}${footerRowIdx}`);
                    const footerCell = sheet.getCell(`A${footerRowIdx}`);
                    footerCell.value = `${t('prepared_by')}: ${excelConfig.preparedBy}`;
                    footerCell.font = { ...defaultFont, bold: true, size: excelConfig.bodyFontSize + 1 };
                    // FIX: Creator Alignment (Left for EN, Right for AR)
                    footerCell.alignment = { vertical: 'middle', horizontal: lang === 'ar' ? 'right' : 'left' };
                    sheet.getRow(footerRowIdx).height = 30;
                }

                // --- 7. WATERMARK ---
                if (excelConfig.watermarkImage) {
                    const finalWatermarkImgStr = await processImageEffect(excelConfig.watermarkImage, excelConfig.watermarkEffect, excelConfig.watermarkOpacity);
                    const imageId = workbook.addImage({
                        base64: finalWatermarkImgStr,
                        extension: 'png',
                    });
                    sheet.addImage(imageId, {
                        tl: { col: 0, row: 0 },
                        br: { col: totalCols, row: sheet.rowCount }, 
                        editAs: 'absolute' 
                    });
                }

                // --- 8. FOOTER IMAGE ---
                if (excelConfig.footerImage) {
                    const finalFooterImgStr = await processImageEffect(excelConfig.footerImage, excelConfig.footerEffect);
                    const { width: footWidth, height: footHeight } = await getImageDimensions(finalFooterImgStr);
                    const imageId = workbook.addImage({
                        base64: finalFooterImgStr,
                        extension: 'png',
                    });
                    const fImgRow = sheet.rowCount + 1;
                    sheet.mergeCells(`A${fImgRow}:${lastColChar}${fImgRow}`);
                    sheet.getRow(fImgRow).height = 80;
                    
                    if (footWidth > 0 && footHeight > 0) {
                        const targetFootHeight = 90;
                        const targetFootWidth = (footWidth / footHeight) * targetFootHeight;
                        const tlCol = Math.max(0, (totalCols / 2) - 1);
                        sheet.addImage(imageId, {
                            tl: { col: tlCol, row: fImgRow - 1 + 0.1 },
                            ext: { width: targetFootWidth, height: targetFootHeight },
                            editAs: 'absolute'
                        });
                    }
                }

                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                saveAs(blob, `Schedule_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            const exportHTML = () => {
                 const days = getCalculatedDays();
                 const isRtl = lang === 'ar';

                 let dateTitle = '';
                 if (scheduleMode === 'month') {
                     dateTitle = `${TRANSLATIONS[lang].months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
                 } else {
                     const startLocale = formatShortDate(new Date(rangeStart));
                     const endLocale = formatShortDate(new Date(rangeEnd));
                     dateTitle = `${startLocale} ${t('to')} ${endLocale}`;
                 }
                 
                 const createBadge = (empId, name, baseClass) => {
                     return `<span class="emp-badge inline-block px-2 py-1 rounded border m-0.5 transition-all duration-200 ${baseClass}" style="font-size: ${viewSettings.cellFontSize}px" data-id="${empId}">${name}</span>`;
                 };

                 let mHead = t('morn_col');
                 let nHead = t('eve_col');
                 let nsHead = t('night_col');
                 let sbHead = t('standby_col');

                 if (showShiftTimes) {
                     const fmtTimes = (arr) => arr.map(x => `<div class="font-normal opacity-75 text-center" style="font-size: ${Math.max(8, viewSettings.headerFontSize - 2)}px">${x}</div>`).join('');
                     mHead += `<div class="mt-1">${fmtTimes(getShiftTimeSummary('morning'))}</div>`;
                     nHead += `<div class="mt-1">${fmtTimes(getShiftTimeSummary('night'))}</div>`;
                     nsHead += `<div class="mt-1">${fmtTimes(getShiftTimeSummary('nightShift'))}</div>`;
                 }

                const lineWeight = viewSettings.lineWeight || '1px';
                const lineColor = viewSettings.lineColor || '#e2e8f0';
                const frameBorders = viewSettings.frameBorders || { top: lineWeight, right: lineWeight, bottom: lineWeight, left: lineWeight };
                const frameColor = viewSettings.frameColor || lineColor;
                const borderStyle = `border-bottom: ${lineWeight} solid ${lineColor}; border-${isRtl ? 'left' : 'right'}: ${lineWeight} solid ${lineColor}; border-color: ${lineColor}; border-style: solid;`;
                const frameStyle = `border-top:${frameBorders.top} solid ${frameColor}; border-right:${frameBorders.right} solid ${frameColor}; border-bottom:${frameBorders.bottom} solid ${frameColor}; border-left:${frameBorders.left} solid ${frameColor}; border-color:${frameColor}; border-style:solid;`;

                 const tableRows = days.map(day => {
                     const dKey = formatDateKey(day);
                     const s = schedule[dKey] || { morning: [], night: [], nightShift: [], standby: [] };
                     const req = requirements[day.getDay()];
                     const isFri = day.getDay() === 5;
                     const isSat = day.getDay() === 6;
                     
                     let trClass = "hover:bg-slate-50 transition-colors";
                     if (isFri) trClass += " bg-gray-100";
                     if (isSat) trClass += " bg-indigo-50/10";

                     const renderCell = (shiftKey, bgClass) => {
                         const ids = s[shiftKey] || [];
                         const badges = ids.map(id => {
                             const e = employees.find(x => x.id === id);
                             return e ? createBadge(e.id, e.name, bgClass) : '';
                         }).join('');
                         return `<td class="p-2 align-top text-center" style="${borderStyle}">
                            <div class="flex flex-wrap gap-1 justify-center">${badges}</div>
                         </td>`;
                     };

                     // Fixed width and center for date cell in export
                     let rowHtml = `<tr class="${trClass}">
                        <td class="p-3 align-top text-center" style="width: 120px; ${borderStyle}">
                            <div class="font-bold text-slate-700" style="font-size: ${viewSettings.headerFontSize}px">${formatShortDate(day)}</div>
                            <div class="uppercase ${isFri ? 'text-red-400 font-bold' : 'text-slate-400'}" style="font-size: ${Math.max(8, viewSettings.headerFontSize - 2)}px">${getDayName(day)}</div>
                        </td>
                        ${renderCell('morning', 'bg-amber-100 border-amber-300 text-amber-900')}
                        ${renderCell('night', 'bg-indigo-100 border-indigo-300 text-indigo-900')}`;
                     
                     if (enabledShifts.nightShift) {
                         rowHtml += renderCell('nightShift', 'bg-purple-100 border-purple-300 text-purple-900');
                     }
                     if (enabledShifts.standby) {
                         rowHtml += renderCell('standby', 'bg-cyan-100 border-cyan-300 text-cyan-900');
                     }

                     let workers = [...s.morning, ...s.night];
                     if(enabledShifts.nightShift) workers = [...workers, ...(s.nightShift||[])];
                     const offDuty = employees.filter(e => !workers.includes(e.id) && !(s.standby || []).includes(e.id));
                     const offBadges = offDuty.map(e => createBadge(e.id, e.name, "bg-slate-100 text-slate-500 border-slate-200")).join('');

                     rowHtml += `<td class="p-2 align-top bg-slate-50/30" style="${borderStyle}"><div class="flex flex-wrap gap-1 justify-center">${offBadges}</div></td></tr>`;
                     return rowHtml;
                 }).join('');

                 let headerHtml = `<th class="p-3 bg-slate-50 text-center text-slate-500 text-xs font-bold uppercase" style="width: 120px; ${borderStyle}">${t('date_col')}</th>
                 <th class="p-3 bg-amber-50/30 text-center text-amber-700 font-bold min-w-[120px]" style="font-size: ${viewSettings.headerFontSize + 2}px; ${borderStyle}">${mHead}</th>
                 <th class="p-3 bg-indigo-50/30 text-center text-indigo-900 font-bold min-w-[120px]" style="font-size: ${viewSettings.headerFontSize + 2}px; ${borderStyle}">${nHead}</th>`;
                 
                 if (enabledShifts.nightShift) {
                     headerHtml += `<th class="p-3 bg-purple-50/30 text-center text-purple-900 font-bold min-w-[120px]" style="font-size: ${viewSettings.headerFontSize + 2}px; ${borderStyle}">${nsHead}</th>`;
                 }
                 if (enabledShifts.standby) {
                     headerHtml += `<th class="p-3 bg-cyan-50/30 text-center text-cyan-900 font-bold min-w-[120px]" style="font-size: ${viewSettings.headerFontSize + 2}px; ${borderStyle}">${sbHead}</th>`;
                 }
                 headerHtml += `<th class="p-3 bg-slate-50 text-center text-slate-500 text-sm font-bold min-w-[120px]" style="${borderStyle}">${t('off_col')}</th>`;

                 const optionsHtml = `<option value="">${t('highlight')}</option>` + employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');

                 const fullHtml = `<!DOCTYPE html>
                 <html lang="${lang}" dir="${isRtl ? 'rtl' : 'ltr'}">
                 <head>
                    <meta charset="UTF-8">
                    <title>${excelConfig.officeName || 'Schedule View'}</title>
                    <script src="https://cdn.tailwindcss.com"><` + `/script>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: ${isRtl ? "'Cairo', sans-serif" : "sans-serif"}; }
                        .emp-badge { cursor: default; }
                    </style>
                    <script>
                        function highlightEmp(select) {
                            const id = select.value;
                            const badges = document.querySelectorAll('.emp-badge');
                            badges.forEach(b => {
                                b.classList.remove('ring-2', 'ring-offset-1', 'ring-blue-500', 'font-bold', 'scale-110', 'z-10', 'shadow-md', 'opacity-20', 'blur-[0.5px]');
                                if (id) {
                                    if (b.getAttribute('data-id') === id) {
                                        b.classList.add('ring-2', 'ring-offset-1', 'ring-blue-500', 'font-bold', 'scale-110', 'z-10', 'shadow-md');
                                    } else {
                                        b.classList.add('opacity-20', 'blur-[0.5px]');
                                    }
                                }
                            });
                        }
                    <` + `/script>
                 </head>
                 <body class="bg-slate-100 min-h-screen p-4 md:p-8 text-slate-900">
                    <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-xl overflow-hidden border" style="${frameStyle}">
                        <div class="p-6 border-b bg-white flex flex-col items-center gap-4 sticky top-0 z-20 shadow-sm" style="border-bottom:${lineWeight} solid ${lineColor}; border-color:${lineColor}; border-style:solid;">
                            <h2 class="text-xl font-semibold text-black">${dateTitle}</h2>
                            <div class="w-full flex flex-col md:flex-row justify-between items-center gap-4">
                                <div>
                                    <h1 class="text-2xl" style="color:${excelConfig.headerColor};font-weight:${weightValue(excelConfig.headerFontWeight)};font-size:${excelConfig.headerFontSize + 4}px">${excelConfig.officeName || t('view_title')}</h1>
                                    <div class="text-sm" style="color:#94a3b8;font-weight:${weightValue(excelConfig.bodyFontWeight)};font-size:${excelConfig.bodyFontSize}px">${t('generated_in')} ${formatShortDate(new Date())}</div>
                                </div>
                                <div class="flex items-center bg-slate-50 border border-slate-300 rounded-md px-3 py-2 shadow-sm">
                                    <select onchange="highlightEmp(this)" class="bg-transparent border-none focus:ring-0 text-slate-700 outline-none text-sm font-medium cursor-pointer">${optionsHtml}</select>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-center border-collapse">
                                <thead class="bg-white" style="color:${excelConfig.headerColor};font-weight:${weightValue(excelConfig.headerFontWeight)};font-size:${excelConfig.headerFontSize}px">
                                    <tr>${headerHtml}</tr>
                                </thead>
                                <tbody class="bg-white" style="color:${excelConfig.textColor};font-weight:${weightValue(excelConfig.bodyFontWeight)};font-size:${excelConfig.bodyFontSize}px;border-color:${lineColor}; border-style:solid;">
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                        <div class="p-4 bg-slate-50 border-t text-center text-xs" style="color:${excelConfig.textColor};font-weight:${weightValue(excelConfig.bodyFontWeight)};font-size:${Math.max(8, excelConfig.bodyFontSize - 1)}px;border-top:${lineWeight} solid ${lineColor}; border-color:${lineColor}; border-style:solid;">
                            ${excelConfig.preparedBy ? t('prepared_by') + ': ' + excelConfig.preparedBy : ''}
                        </div>
                    </div>
                 </body>
                 </html>`;

                 const blob = new Blob([fullHtml], {type: 'text/html'});
                 saveAs(blob, 'Schedule_View.html');
            };

              const getCssFilter = (effect, opacityOverride) => {
                  const baseOpacity = (effect === 'washout' || effect === 'washout_grayscale') ? 0.2 : 1;
                  const opacity = Math.max(0, Math.min(1, opacityOverride ?? baseOpacity));
                  if(effect === 'grayscale') return { filter: 'grayscale(100%)', opacity };
                  if(effect === 'washout') return { filter: 'brightness(1.2) contrast(0.8)', opacity };
                  if(effect === 'washout_grayscale') return { filter: 'grayscale(100%) brightness(1.2) contrast(0.8)', opacity };
                  return { filter: 'none', opacity };
              };

            const PreviewSection = () => {
                  const headFilter = getCssFilter(excelConfig.headerEffect);
                  const footFilter = getCssFilter(excelConfig.footerEffect);
                  const waterFilter = getCssFilter(excelConfig.watermarkEffect, excelConfig.watermarkOpacity);

                const previewColumns = [
                    { key: 'date', label: t('date_col'), bg: excelConfig.dateColumnColor },
                    { key: 'day', label: t('day'), bg: excelConfig.dateColumnColor },
                    { key: 'morning', label: t('morn_col'), bg: excelConfig.mornCellColor },
                    { key: 'night', label: t('eve_col'), bg: excelConfig.eveCellColor },
                ];

                if (enabledShifts.nightShift) previewColumns.push({ key: 'nightShift', label: t('night_col'), bg: excelConfig.nightCellColor });
                if (enabledShifts.standby) previewColumns.push({ key: 'standby', label: t('standby_col'), bg: excelConfig.standbyCellColor });
                previewColumns.push({ key: 'off', label: t('off_col'), bg: excelConfig.offCellColor });

                const gridStyle = { gridTemplateColumns: `repeat(${previewColumns.length}, minmax(0, 1fr))` };
                const headerWeight = weightValue(excelConfig.headerFontWeight);
                const bodyWeight = weightValue(excelConfig.bodyFontWeight);
                const linePx = lineWeightToPx(excelConfig.lineWeight || 'thin');
                const framePx = {
                    top: lineWeightToPx(excelConfig.frameBorders?.top || excelConfig.lineWeight || 'thin'),
                    right: lineWeightToPx(excelConfig.frameBorders?.right || excelConfig.lineWeight || 'thin'),
                    bottom: lineWeightToPx(excelConfig.frameBorders?.bottom || excelConfig.lineWeight || 'thin'),
                    left: lineWeightToPx(excelConfig.frameBorders?.left || excelConfig.lineWeight || 'thin'),
                };
                const lineColor = excelConfig.lineColor || '#e2e8f0';
                const frameColor = excelConfig.frameColor || lineColor;

                return (
                    <div className="w-full bg-slate-200 p-4 rounded-lg overflow-hidden flex justify-center">
                        <div className="bg-white w-[500px] min-h-[600px] shadow-2xl flex flex-col scale-90 md:scale-100 origin-top excel-preview-shadow text-slate-800 relative" style={{
                            borderTop: `${framePx.top} solid ${frameColor}`,
                            borderRight: `${framePx.right} solid ${frameColor}`,
                            borderBottom: `${framePx.bottom} solid ${frameColor}`,
                            borderLeft: `${framePx.left} solid ${frameColor}`
                        }}>
                            {excelConfig.watermarkImage && (
                                  <div className="absolute inset-0 z-0 pointer-events-none flex items-center justify-center p-10 overflow-hidden">
                                       <img src={excelConfig.watermarkImage} className="w-full h-full object-contain" style={{ filter: waterFilter.filter, opacity: waterFilter.opacity }} />
                                  </div>
                              )}
                              <div className={`h-24 w-full bg-slate-50 flex items-center justify-center relative overflow-hidden z-10 px-6`} style={{ borderBottom: `${linePx} solid ${lineColor}` }}>
                                {excelConfig.headerImage ? (
                                      <img src={excelConfig.headerImage} className="h-full object-contain" style={{ filter: headFilter.filter, opacity: headFilter.opacity }} />
                                ) : (
                                    <span className="text-xs text-slate-300 uppercase font-bold tracking-widest">{t('header_image')}</span>
                                )}
                            </div>
                            <div className="p-4 text-center z-10 relative" style={{
                                color: excelConfig.headerColor,
                                fontWeight: headerWeight,
                                fontSize: `${excelConfig.headerFontSize + 4}px`,
                                borderBottom: `${linePx} solid ${lineColor}`
                            }}>
                                {excelConfig.officeName || "Office Name"}
                            </div>
                            <div className="flex-1 p-4 z-10 relative">
                                <div className="bg-white/50 backdrop-blur-[1px]" style={{
                                    borderTop: `${linePx} solid ${lineColor}`,
                                    borderRight: `${linePx} solid ${lineColor}`,
                                    borderBottom: `${linePx} solid ${lineColor}`,
                                    borderLeft: `${linePx} solid ${lineColor}`
                                }}>
                                    {/* Preview now shows header background */}
                                    <div className="grid text-xs p-2 text-center" style={{
                                        ...gridStyle,
                                        backgroundColor: excelConfig.headerRowColor,
                                        color: excelConfig.headerColor,
                                        fontWeight: headerWeight,
                                        fontSize: `${excelConfig.headerFontSize}px`,
                                        borderBottom: `${linePx} solid ${lineColor}`,
                                        borderLeft: `${linePx} solid ${lineColor}`,
                                        borderRight: `${linePx} solid ${lineColor}`
                                    }}>
                                        {previewColumns.map((col, idx) => {
                                            const sampleLabel = idx === 0 ? (col.label || '') : '';
                                            return (
                                                <div key={col.key} style={{ backgroundColor: 'transparent' }}>{sampleLabel}</div>
                                            );
                                        })}
                                    </div>
                                    {[1,2,3].map(i => (
                                        <div key={i} className="grid text-xs p-0 text-center" style={{
                                            ...gridStyle,
                                            color: excelConfig.textColor,
                                            fontWeight: bodyWeight,
                                            fontSize: `${excelConfig.bodyFontSize}px`,
                                            borderBottom: `${linePx} solid ${lineColor}`,
                                            borderLeft: `${linePx} solid ${lineColor}`,
                                            borderRight: `${linePx} solid ${lineColor}`
                                        }}>
                                            {previewColumns.map(col => {
                                                let text = '';
                                                if (col.key === 'date') text = '--/--';
                                                else if (col.key === 'day') text = '---';
                                                else if (col.key === 'morning') text = 'Emp 1 / Emp 2';
                                                else if (col.key === 'night') text = 'Emp 3';
                                                else if (col.key === 'nightShift') text = 'Emp 4';
                                                else if (col.key === 'standby') text = t('standby');
                                                else if (col.key === 'off') text = t('off');
                                                const isDate = col.key === 'date' || col.key === 'day';
                                                const cellColor = isDate ? excelConfig.headerColor : excelConfig.textColor;
                                                const cellWeight = isDate ? headerWeight : bodyWeight;
                                                return <div key={col.key} className="p-2" style={{ backgroundColor: col.bg, color: cellColor, fontWeight: cellWeight }}>{text}</div>;
                                            })}
                                        </div>
                                    ))}
                                    <div className="p-2 text-center text-xs text-slate-400 italic" style={{
                                        borderTop: `${linePx} solid ${lineColor}`,
                                        borderLeft: `${linePx} solid ${lineColor}`,
                                        borderRight: `${linePx} solid ${lineColor}`
                                    }}>... {t('rest_of_data')} ...</div>
                                </div>
                            </div>
                            <div className="p-4 pt-0 text-sm flex justify-between items-center z-10 relative" style={{
                                color: excelConfig.textColor,
                                fontWeight: bodyWeight,
                                fontSize: `${Math.max(8, excelConfig.bodyFontSize - 1)}px`,
                                borderTop: `${linePx} solid ${lineColor}`
                            }}>
                                <span>{t('prepared_by')}: {excelConfig.preparedBy || "..."}</span>
                            </div>
                              <div className={`h-20 w-full bg-slate-50 flex items-center justify-center relative overflow-hidden z-10`} style={{ borderTop: `${linePx} solid ${lineColor}` }}>
                                {excelConfig.footerImage ? (
                                      <img src={excelConfig.footerImage} className="w-full h-full object-contain" style={{ filter: footFilter.filter, opacity: footFilter.opacity }} />
                                ) : (
                                    <span className="text-xs text-slate-300 uppercase font-bold tracking-widest">{t('footer_image')}</span>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            const generateSchedule = async () => {
                setIsGenerating(true);
                setTimeout(() => {
                    try {
                        const days = getCalculatedDays();
                        const newSchedule = {}; 
                        let empState = {};
                        employees.forEach(e => { empState[e.id] = { consecutiveWork: 0, daysResting: 10, consecutiveStandby: 0, totalShifts: 0, threeDayWorkStreakCount: 0, longRestCount: 0 }; });

                        days.forEach(day => {
                            const dKey = formatDateKey(day);
                            const dayOfWeek = day.getDay();
                            const req = requirements[dayOfWeek];
                            newSchedule[dKey] = { morning: [], night: [], nightShift: [], standby: [] };

                            const maxShifts = Math.max(...Object.values(empState).map(s => s.totalShifts));

                            const getCandidateScore = (empId, shiftType) => {
                                const state = empState[empId];
                                const pref = preferences[empId] || 'neutral';
                                const avail = availability[empId]?.[dKey];

                                if (!enabledShifts.nightShift && avail === 'night_only') return -100000;
                                if (!enabledShifts.standby && avail === 'standby_only') return -100000;
                                if (avail === 'unavailable') return -100000;
                                if (avail === 'standby_only' && shiftType !== 'standby') return -100000;
                                if (avail === 'evening_only' && shiftType !== 'night') return -100000;
                                if (avail === 'night_only' && shiftType !== 'nightShift') return -100000;
                                if ((shiftType === 'night' || shiftType === 'nightShift') && avail === 'morning_only') return -100000;
                                
                                const s = newSchedule[dKey];
                                const alreadyWorkingToday = s.morning.includes(empId) || s.night.includes(empId) || s.nightShift.includes(empId);
                                const alreadyStandbyToday = s.standby.includes(empId);
                                if (alreadyWorkingToday || alreadyStandbyToday) return -100000;

                                let score = 1000 + (Math.random() * 20 - 10);
                                const restNeeded = patternType === '2-2' ? 2 : 1;
                                const isWorkShift = shiftType === 'morning' || shiftType === 'night' || shiftType === 'nightShift';

                                if (isWorkShift && (maxShifts - state.totalShifts >= 2)) score += 15000;
                                if (avail === 'priority') score += 20000;
                                if (avail === 'standby_only' && shiftType === 'standby') score += 12000;

                                if (patternType === 'hybrid') {
                                    if(isWorkShift) { 
                                        if (state.consecutiveWork === 0) { if (state.daysResting >= 1) score += 5000; if (state.daysResting >= 2) score += 8000; } 
                                        else if (state.consecutiveWork === 1) score += 3000; 
                                        else if (state.consecutiveWork >= 2) { score -= 5000; if (state.consecutiveWork >= 3) score -= 50000; }
                                    }
                                } else if (patternType === '2-1-1' && enabledShifts.standby) {
                                    if (isWorkShift) {
                                        if (state.consecutiveWork >= 2) return -60000; 
                                        if (state.consecutiveStandby > 0) score -= 50000; 
                                        if (state.daysResting > 0) score += 20000; 
                                        if (state.consecutiveWork === 1) score += 10000; 
                                    } else if (shiftType === 'standby') {
                                        if (state.consecutiveWork === 2) score += 50000; 
                                        else if (state.consecutiveWork === 1) score -= 10000; 
                                        else if (state.consecutiveWork === 0) score -= 50000; 
                                        if (state.consecutiveStandby > 0) return -60000; 
                                        if (state.daysResting > 0) score -= 40000; 
                                    }
                                } else { 
                                    if (isWorkShift) {
                                        if (state.consecutiveWork === 1) score += 5000; 
                                        else if (state.consecutiveWork >= 2) { if (state.threeDayWorkStreakCount >= 1) score -= 100000; else score -= 5000; }
                                        if (state.daysResting >= 2) { if (state.longRestCount >= 1) score += 12000; else score -= 4000; } else if (state.daysResting < restNeeded) score -= 4000;
                                    }
                                }
                                if (avail === 'evening_only' && shiftType === 'night') score += 5000;
                                if (avail === 'night_only' && shiftType === 'nightShift') score += 5000;
                                if (avail === 'morning_only' && shiftType === 'morning') score += 5000;
                                if (isWorkShift) score -= (state.totalShifts * 50); 
                                if (shiftType === 'night' || shiftType === 'nightShift') { if (pref === 'night') score += 200; else if (pref === 'morning') score -= 50; } 
                                else if (shiftType === 'morning') { if (pref === 'morning') score += 200; else if (pref === 'night') score -= 50; }
                                return score;
                            };

                            const assignShift = (shiftType, countNeeded) => {
                                for (let i = 0; i < countNeeded; i++) {
                                    let candidates = employees.map(e => ({ id: e.id, score: getCandidateScore(e.id, shiftType) }));
                                    let validCandidates = candidates.filter(c => c.score > -2000); 
                                    if (validCandidates.length === 0) validCandidates = candidates.filter(c => c.score > -90000);
                                    if (validCandidates.length > 0) {
                                        validCandidates.sort((a, b) => b.score - a.score);
                                        const chosenId = validCandidates[0].id;
                                        newSchedule[dKey][shiftType].push(chosenId);
                                        if (shiftType !== 'standby') empState[chosenId].totalShifts++;
                                    }
                                }
                            };
                            assignShift('nightShift', enabledShifts.nightShift ? req.nightShift : 0);
                            assignShift('night', req.night); 
                            assignShift('morning', req.morning);
                            assignShift('standby', enabledShifts.standby ? req.standby : 0);

                            employees.forEach(e => {
                                const s = newSchedule[dKey];
                                const worked = s.morning.includes(e.id) || s.night.includes(e.id) || (s.nightShift||[]).includes(e.id);
                                const onStandby = (s.standby || []).includes(e.id);
                                if (worked) { 
                                    empState[e.id].consecutiveWork++; 
                                    if (empState[e.id].daysResting >= 3) empState[e.id].longRestCount++;
                                    empState[e.id].daysResting = 0; empState[e.id].consecutiveStandby = 0;
                                    if (empState[e.id].consecutiveWork === 3) empState[e.id].threeDayWorkStreakCount++;
                                } else if (onStandby && enabledShifts.standby) { empState[e.id].consecutiveWork = 0; empState[e.id].daysResting = 0; empState[e.id].consecutiveStandby++; }
                                else { empState[e.id].consecutiveWork = 0; empState[e.id].daysResting++; empState[e.id].consecutiveStandby = 0; }
                            });
                        });
                        setSchedule(newSchedule);
                    } catch (error) { console.error(error); alert(t('err_gen')); } finally { setIsGenerating(false); }
                }, 100);
            };

            const stats = useMemo(() => {
                const data = {};
                const days = getCalculatedDays();
                const issues = [];
                const criticalIssues = [];
                const unfilledDays = new Set();
                let grandTotal = 0;
                employees.forEach(emp => { data[emp.id] = { total: 0, morning: 0, night: 0, nightShift: 0, standbyCount: 0, rest: 0, history: [] }; });
                days.forEach(day => {
                    const dKey = formatDateKey(day);
                    const daySched = schedule[dKey] || { morning: [], night: [], nightShift: [], standby: [] };
                    const req = requirements[day.getDay()] || {};
                    const shiftChecks = [
                        { key: 'morning', label: t('morn'), required: req.morning || 0, enabled: true },
                        { key: 'night', label: t('eve'), required: req.night || 0, enabled: true },
                        { key: 'nightShift', label: t('night'), required: req.nightShift || 0, enabled: enabledShifts.nightShift },
                        { key: 'standby', label: t('standby'), required: req.standby || 0, enabled: enabledShifts.standby }
                    ];
                    shiftChecks.forEach(check => {
                        const actual = (daySched[check.key] || []).length;
                        if (check.enabled && check.required > actual) {
                            const missing = check.required - actual;
                            criticalIssues.push(
                                t('warning_unfilled_detail')
                                    .replace('{shift}', check.label)
                                    .replace('{date}', formatShortDate(day))
                                    .replace('{count}', missing)
                            );
                            unfilledDays.add(dKey);
                        }
                    });
                    employees.forEach(emp => {
                        const worked = daySched.morning.includes(emp.id) || daySched.night.includes(emp.id) || (daySched.nightShift||[]).includes(emp.id);
                        const onStandby = (daySched.standby||[]).includes(emp.id);
                        if (worked) {
                            data[emp.id].total++; grandTotal++; data[emp.id].history.push(1);
                            if (daySched.morning.includes(emp.id)) data[emp.id].morning++;
                            if (daySched.night.includes(emp.id)) data[emp.id].night++;
                            if ((daySched.nightShift||[]).includes(emp.id)) data[emp.id].nightShift++;
                        } else if (onStandby && enabledShifts.standby) { data[emp.id].standbyCount++; data[emp.id].rest++; data[emp.id].history.push(0); } else { data[emp.id].rest++; data[emp.id].history.push(0); }
                    });
                });
                const totals = Object.values(data).map(d => d.total);
                const avg = totals.reduce((a,b)=>a+b,0) / totals.length || 0;
                const minShifts = Math.min(...totals);
                const maxShifts = Math.max(...totals);
                if (maxShifts - minShifts > 2) issues.push(`${t('issue_imbalance')} ${maxShifts - minShifts} (Max 2)`);
                employees.forEach(emp => {
                    let consWork = 0; let consRest = 0; let threeDayWorkStreaks = 0; let longRestPeriods = 0;
                    data[emp.id].history.forEach((val, i) => {
                        if (val === 1) { consWork++; if (consRest >= 3) longRestPeriods++; consRest = 0; } else { if (consWork >= 3) { threeDayWorkStreaks++; issues.push(`${emp.name}: ${t('issue_3day')} (Day ${i-consWork+1})`); } consWork = 0; consRest++; }
                    });
                    if (consWork >= 3) { threeDayWorkStreaks++; issues.push(`${emp.name}: ${t('issue_3day')} (End)`); }
                    if (consRest >= 3) { longRestPeriods++; }
                    if (threeDayWorkStreaks > 1) issues.push(`${emp.name}: ${t('issue_viol_streak')}`);
                    if (longRestPeriods > 1) issues.push(`${emp.name}: ${t('issue_viol_rest')}`);
                });
                return { data, issues: [...criticalIssues, ...issues], avg, grandTotal, unfilledDays };
            }, [schedule, employees, currentDate, lang, enabledShifts, scheduleMode, rangeStart, rangeEnd, requirements]);

            const handleBulkAvailability = (empId, status) => {
                const days = getCalculatedDays();
                setAvailability(prev => {
                    const newAvail = { ...prev }; if (!newAvail[empId]) newAvail[empId] = {};
                    if ((status === 'night_only' && !enabledShifts.nightShift) || (status === 'standby_only' && !enabledShifts.standby)) return newAvail;
                    if (status.startsWith('priority_day_')) {
                        const targetDayIdx = parseInt(status.split('_')[2]);
                        days.forEach(day => { 
                            if (day.getDay() === targetDayIdx) newAvail[empId][formatDateKey(day)] = 'priority'; 
                        }); 
                    } else { 
                        days.forEach(day => { const dKey = formatDateKey(day); if (status === "") delete newAvail[empId][dKey]; else newAvail[empId][dKey] = status; }); 
                    }
                    return newAvail;
                });
                setBulkSelectState(prev => ({...prev, [empId]: "select_action"}));
            };

            const toggleAssignment = (dateKey, shift, empId) => {
                setSchedule(prev => {
                    const daySched = prev[dateKey] || { morning: [], night: [], nightShift: [], standby: [] };
                    const currentList = daySched[shift] || [];
                    if (currentList.includes(empId)) { return { ...prev, [dateKey]: { ...daySched, [shift]: currentList.filter(id => id !== empId) } }; }
                    const isWorking = daySched.morning.includes(empId) || daySched.night.includes(empId) || (daySched.nightShift||[]).includes(empId);
                    const isOnStandby = (daySched.standby||[]).includes(empId);
                    if (shift === 'morning' || shift === 'night' || shift === 'nightShift') { if (isWorking || isOnStandby) return prev; }
                    if (shift === 'standby') { if (isWorking || isOnStandby) return prev; }
                    return { ...prev, [dateKey]: { ...daySched, [shift]: [...currentList, empId] } };
                });
            };

            const lineWeight = viewSettings.lineWeight || '1px';
            const lineColor = viewSettings.lineColor || '#e2e8f0';
            const frameBorders = viewSettings.frameBorders || { top: lineWeight, right: lineWeight, bottom: lineWeight, left: lineWeight };
            const frameColor = viewSettings.frameColor || lineColor;

            return (
                <div className={`min-h-screen p-2 md:p-8 ${lang === 'ar' ? 'font-[Cairo]' : ''}`}>
                    <div className="max-w-7xl mx-auto mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div className="flex flex-col gap-3">
                            <div className="flex items-center gap-4">
                                <h1 className="text-3xl font-bold text-slate-800">{t('title')}</h1>
                                <button onClick={toggleLanguage} className="flex items-center gap-1 bg-white border border-slate-300 px-3 py-1 rounded-full text-sm font-medium hover:bg-slate-50 transition-colors">
                                    <Globe size={16} /> {lang === 'en' ? 'العربية' : 'English'}
                                </button>
                            </div>
                            <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center bg-white p-2 rounded-lg border border-slate-200 shadow-sm">
                                <div className="flex bg-slate-100 rounded p-1">
                                    <button onClick={()=>setScheduleMode('month')} className={`px-3 py-1 rounded text-sm transition-all ${scheduleMode==='month' ? 'bg-white shadow text-slate-800 font-bold' : 'text-slate-500 hover:text-slate-700'}`}>
                                        <CalendarIcon size={16} className="inline me-1 mb-0.5"/>{t('mode_month')}
                                    </button>
                                    <button onClick={()=>setScheduleMode('range')} className={`px-3 py-1 rounded text-sm transition-all ${scheduleMode==='range' ? 'bg-white shadow text-slate-800 font-bold' : 'text-slate-500 hover:text-slate-700'}`}>
                                        <ArrowDownCircle size={16} className="inline me-1 mb-0.5"/>{t('mode_range')}
                                    </button>
                                </div>
                                {scheduleMode === 'month' ? (
                                    <div className="flex items-center gap-2">
                                        <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() - 1)))} className="p-1 hover:bg-slate-200 rounded"><ChevronLeft size={20}/></button>
                                        <span className="text-xl font-medium w-48 text-center">{TRANSLATIONS[lang].months[currentDate.getMonth()]} {currentDate.getFullYear()}</span>
                                        <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + 1)))} className="p-1 hover:bg-slate-200 rounded"><ChevronRight size={20}/></button>
                                    </div>
                                ) : (
                                    <div className="flex items-center gap-2">
                                        <div className="flex flex-col">
                                            <label className="text-[10px] text-slate-400 font-bold uppercase">{t('date_start')}</label>
                                            <input type="date" value={rangeStart} onChange={(e)=>setRangeStart(e.target.value)} className="border rounded p-1 text-sm text-slate-700"/>
                                        </div>
                                        <div className="text-slate-300"><ChevronRight size={20}/></div>
                                        <div className="flex flex-col">
                                            <label className="text-[10px] text-slate-400 font-bold uppercase">{t('date_end')}</label>
                                            <input type="date" value={rangeEnd} onChange={(e)=>setRangeEnd(e.target.value)} className="border rounded p-1 text-sm text-slate-700"/>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="flex bg-white p-1 rounded-lg shadow-sm border border-slate-200 overflow-x-auto w-full md:w-auto">
                            {['schedule', 'availability', 'employees', 'settings', 'export_opts'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 rounded-md flex items-center gap-2 capitalize whitespace-nowrap ${activeTab === tab ? 'bg-blue-600 text-white' : 'hover:bg-slate-100'}`}>
                                    {tab === 'export_opts' && <FileSpreadsheet size={16}/>}
                                    {t('tabs')[tab]}
                                </button>
                            ))}
                        </div>
                    </div>

                    <main className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <div className="lg:col-span-1 space-y-6">
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 className="font-semibold text-slate-700 mb-4 flex items-center gap-2"><RefreshCw size={18} /> {t('actions')}</h3>
                                <div className="mb-4">
                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">{t('pattern')}</label>
                                    <select value={patternType} onChange={(e) => setPatternType(e.target.value)} className="w-full p-2 border border-slate-300 rounded-md text-sm">
                                        <option value="hybrid">{t('phybrid')}</option>
                                        <option value="2-2">{t('p22')}</option>
                                        <option value="2-1">{t('p21')}</option>
                                        {enabledShifts.standby && <option value="2-1-1">{t('p211')}</option>}
                                    </select>
                                </div>
                                <div className="mb-4">
                                     <label className="flex items-center gap-2 cursor-pointer bg-slate-50 p-2 rounded border border-slate-200 hover:bg-slate-100 transition-colors">
                                         <input type="checkbox" checked={showWarnings} onChange={e=>setShowWarnings(e.target.checked)} className="w-4 h-4 text-red-500 rounded focus:ring-red-500" />
                                         <span className="text-sm font-medium text-slate-700">{t('show_warnings')}</span>
                                     </label>
                                </div>

                                <div className="grid grid-cols-5 gap-2">
                                    <button onClick={generateSchedule} disabled={isGenerating} className={`col-span-4 py-3 text-white rounded-md font-medium shadow-sm transition-all flex justify-center items-center gap-2 ${isGenerating ? 'bg-indigo-400 cursor-wait' : 'bg-indigo-600 hover:bg-indigo-700'}`}>
                                        {isGenerating ? t('balancing') : t('generate')}
                                    </button>
                                    <button onClick={clearSchedule} className="col-span-1 bg-red-100 text-red-600 hover:bg-red-200 rounded-md flex justify-center items-center" title={t('clear')}>
                                        <Trash2 size={20} />
                                    </button>
                                </div>
                                <div className="grid grid-cols-2 gap-2 mt-3 pt-3 border-t border-slate-100">
                                     <button onClick={saveData} className="py-2 border border-slate-300 hover:bg-slate-50 text-slate-700 rounded-md flex justify-center items-center gap-2 text-xs font-medium"><Save size={16} /> {t('save_data')}</button>
                                     <button onClick={triggerLoad} className="py-2 border border-slate-300 hover:bg-slate-50 text-slate-700 rounded-md flex justify-center items-center gap-2 text-xs font-medium"><Upload size={16} /> {t('load_data')}</button>
                                     <input type="file" ref={fileInputRef} onChange={loadData} className="hidden" accept=".json" />
                                </div>
                                <div className="grid grid-cols-2 gap-2 mt-2">
                                    <button onClick={exportCSV} className="py-2 border border-slate-300 hover:bg-slate-50 text-slate-700 rounded-md flex justify-center items-center gap-2 text-xs"><Download size={16} /> {t('export')}</button>
                                    <button onClick={exportExcel} className="py-2 border border-emerald-300 bg-emerald-50 hover:bg-emerald-100 text-emerald-700 rounded-md flex justify-center items-center gap-2 text-xs font-medium"><FileSpreadsheet size={16} /> {t('export_excel')}</button>
                                </div>
                                <button onClick={exportHTML} className="w-full mt-2 py-2 border border-blue-300 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-md flex justify-center items-center gap-2 text-xs font-medium"><Globe size={16} /> {t('export_html')}</button>
                            </div>

                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <div className="flex justify-between items-baseline mb-4">
                                    <h3 className="font-semibold text-slate-700">{t('stats')}</h3>
                                    <span className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-600 font-medium">{t('total')}: {stats.grandTotal}</span>
                                </div>
                                <div className="text-xs text-center text-slate-400 mb-2">{t('target')}: {Math.round(stats.avg * 10) / 10} {t('shifts_person')}</div>
                                <div className="space-y-4">
                                    {employees.map(emp => {
                                        const s = stats.data[emp.id];
                                        const pref = preferences[emp.id];
                                        let diff = s.total - stats.avg;
                                        let cardBg = 'bg-transparent';
                                        if (diff > 1.5) cardBg = 'bg-red-50 -mx-2 px-2 py-1 rounded'; 
                                        if (diff < -1.5) cardBg = 'bg-blue-50 -mx-2 px-2 py-1 rounded'; 

                                        return (
                                            <div key={emp.id} className={`text-sm ${cardBg}`}>
                                            <div className="flex justify-between mb-1 items-center">
                                                <div className="flex items-center gap-1">
                                                    <span className="font-semibold text-slate-700">{emp.name}</span>
                                                    {pref === 'night' && <Moon size={12} className="text-indigo-600"/>}
                                                    {pref === 'morning' && <Sun size={12} className="text-amber-500"/>}
                                                </div>
                                                <span className={`font-mono px-2 py-0.5 rounded text-xs ${Math.abs(s.total - stats.avg) > 1.5 ? 'bg-red-100 text-red-700 font-bold' : 'bg-slate-100'}`}>{s.total}</span>
                                            </div>
                                            <div className="h-2 bg-slate-100 rounded-full overflow-hidden flex w-full mb-1">
                                                <div className="bg-amber-400" style={{ width: `${s.total ? (s.morning / s.total) * 100 : 0}%` }}></div>
                                                <div className="bg-indigo-900" style={{ width: `${s.total ? (s.night / s.total) * 100 : 0}%` }}></div>
                                                {enabledShifts.nightShift && <div className="bg-purple-900" style={{ width: `${s.total ? (s.nightShift / s.total) * 100 : 0}%` }}></div>}
                                            </div>
                                            <div className="flex flex-col gap-2 text-[11px] text-slate-600">
                                                <div className="flex items-center justify-between gap-3 flex-wrap w-full">
                                                    {[
                                                        { key: 'morn', label: t('morn'), count: s.morning, dot: 'bg-amber-400', show: true },
                                                        { key: 'eve', label: t('eve'), count: s.night, dot: 'bg-indigo-900', show: true },
                                                        { key: 'night', label: t('night'), count: s.nightShift, dot: 'bg-purple-900', show: enabledShifts.nightShift }
                                                    ]
                                                        .filter(item => item.show)
                                                        .map(item => (
                                                            <div key={item.key} className="flex items-center gap-1">
                                                                <span className={`w-2 h-2 rounded-full ${item.dot}`}></span>
                                                                <span>{item.label}</span>
                                                                <span className="font-semibold text-slate-800">{item.count}</span>
                                                            </div>
                                                        ))}
                                                </div>

                                                <div className="flex items-center justify-between gap-3 flex-wrap w-full">
                                                    {[
                                                        { key: 'standby', label: t('standby'), count: s.standbyCount, dot: 'bg-cyan-600', show: enabledShifts.standby },
                                                        { key: 'rest', label: t('off'), count: s.rest, dot: 'bg-slate-400', show: true }
                                                    ]
                                                        .filter(item => item.show)
                                                        .map(item => (
                                                            <div key={item.key} className="flex items-center gap-1">
                                                                <span className={`w-2 h-2 rounded-full ${item.dot}`}></span>
                                                                <span>{item.label}</span>
                                                                <span className="font-semibold text-slate-800">{item.count}</span>
                                                            </div>
                                                        ))}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                                </div>
                            </div>
                            
                            {showWarnings && stats.issues.length > 0 && (
                                <div className="bg-red-50 p-4 rounded-xl border border-red-100 max-h-60 overflow-auto warnings-scroll">
                                    <h3 className="font-semibold text-red-800 mb-2 flex items-center gap-2 text-sm sticky top-0 bg-red-50"><AlertTriangle size={16}/> {t('warnings')} ({stats.issues.length})</h3>
                                    <ul className="list-disc list-inside text-xs text-red-700 space-y-1">
                                        {stats.issues.map((issue, idx) => <li key={idx}>{issue}</li>)}
                                    </ul>
                                </div>
                            )}
                        </div>

                        <div className="lg:col-span-3 bg-white rounded-xl shadow-sm border overflow-hidden min-h-[600px] flex flex-col" style={{ borderTopWidth: frameBorders.top, borderRightWidth: frameBorders.right, borderBottomWidth: frameBorders.bottom, borderLeftWidth: frameBorders.left, borderColor: frameColor, borderStyle: 'solid' }}>
                            {activeTab === 'schedule' && (
                                <div className="flex flex-col h-full">
                                    <div className="p-4 border-b bg-slate-50 flex flex-wrap justify-between items-center sticky top-0 gap-4" style={{ borderBottomWidth: lineWeight, borderColor: lineColor, borderStyle: 'solid' }}>
                                        <div className="flex items-center gap-4">
                                            <h2 className="font-bold text-slate-700">{t('view_title')}</h2>
                                            <div className="flex items-center bg-white border border-slate-300 rounded-md px-2 py-1 shadow-sm">
                                                <Eye size={16} className="text-slate-400 me-2"/>
                                                <select value={highlightedEmp} onChange={(e)=>setHighlightedEmp(e.target.value)} className="text-sm bg-transparent border-none focus:ring-0 text-slate-700 outline-none">
                                                    <option value="">{t('highlight')}</option>
                                                    {employees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                                </select>
                                                {highlightedEmp && <button onClick={()=>setHighlightedEmp('')} className="ms-2 text-slate-400 hover:text-red-500"><Trash2 size={14}/></button>}
                                            </div>
                                        </div>
                                        <div className="flex gap-4 text-xs font-medium text-slate-500">
                                            <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-amber-400"></span> {t('morn')}</div>
                                            <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-indigo-900"></span> {t('eve')}</div>
                                            {enabledShifts.nightShift && <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-purple-900"></span> {t('night')}</div>}
                                            {enabledShifts.standby && <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-cyan-600"></span> {t('standby')}</div>}
                                        </div>
                                    </div>
                                    <div className="overflow-auto flex-1 p-0 custom-scroll">
                                        <table className="w-full text-center border-collapse table-fixed">
                                            <thead className="bg-white sticky top-0 z-10 shadow-sm">
                                                <tr style={{ borderBottomWidth: lineWeight, borderColor: lineColor, borderStyle: 'solid' }}>
                                                    {/* FIXED: Date column with fixed width and center alignment */}
                                                    <th className="p-3 bg-slate-50 text-slate-500 font-bold uppercase text-center w-[120px]" style={{ fontSize: `${viewSettings.headerFontSize}px`, borderBottomWidth: lineWeight, borderColor: lineColor, borderStyle: 'solid', width: '120px' }}>{t('date_col')}</th>

                                                    <th className="p-3 bg-amber-50/30 text-amber-700 font-bold text-center" style={{ fontSize: `${viewSettings.headerFontSize + 2}px`, borderBottomWidth: lineWeight, borderColor: lineColor, borderStyle: 'solid' }}>
                                                        {t('morn_col')}
                                                        {showShiftTimes && (
                                                            <div className="font-normal mt-1 opacity-80 space-y-1 text-center" style={{ fontSize: `${Math.max(8, viewSettings.headerFontSize - 2)}px` }}>
                                                                {getShiftTimeSummary('morning').map(line => <div key={line}>{line}</div>)}
                                                            </div>
                                                        )}
                                                    </th>
                                                    <th className="p-3 bg-indigo-50/30 text-indigo-900 font-bold text-center" style={{ fontSize: `${viewSettings.headerFontSize + 2}px`, borderBottomWidth: lineWeight, borderColor: lineColor, borderStyle: 'solid' }}>
                                                        {t('eve_col')}
                                                        {showShiftTimes && (
                                                            <div className="font-normal mt-1 opacity-80 space-y-1 text-center" style={{ fontSize: `${Math.max(8, viewSettings.headerFontSize - 2)}px` }}>
                                                                {getShiftTimeSummary('night').map(line => <div key={line}>{line}</div>)}
                                                            </div>
                                                        )}
                                                    </th>
                                                    {enabledShifts.nightShift && (
                                                        <th className="p-3 bg-purple-50/30 text-purple-900 font-bold text-center" style={{ fontSize: `${viewSettings.headerFontSize + 2}px`, borderBottomWidth: lineWeight, borderColor: lineColor, borderStyle: 'solid' }}>
                                                            {t('night_col')}
                                                            {showShiftTimes && (
                                                                <div className="font-normal mt-1 opacity-80 space-y-1 text-center" style={{ fontSize: `${Math.max(8, viewSettings.headerFontSize - 2)}px` }}>
                                                                    {getShiftTimeSummary('nightShift').map(line => <div key={line}>{line}</div>)}
                                                                </div>
                                                            )}
                                                        </th>
                                                    )}
                                                    {enabledShifts.standby && <th className="p-3 bg-cyan-50/30 text-cyan-900 font-bold text-center" style={{ fontSize: `${viewSettings.headerFontSize + 2}px`, borderBottomWidth: lineWeight, borderColor: lineColor, borderStyle: 'solid' }}>{t('standby_col')}</th>}
                                                    <th className="p-3 text-slate-500 font-bold text-center" style={{ fontSize: `${viewSettings.headerFontSize}px`, borderBottomWidth: lineWeight, borderColor: lineColor, borderStyle: 'solid' }}>{t('off_col')}</th>
                                                </tr>
                                            </thead>
                                            <tbody className="" style={{ borderColor: lineColor, borderStyle: 'solid' }}>
                                                {getCalculatedDays().map(day => {
                                                    const dKey = formatDateKey(day);
                                                    const s = schedule[dKey] || { morning: [], night: [], nightShift: [], standby: [] };
                                                    const req = requirements[day.getDay()];
                                                    const isFri = day.getDay() === 5;
                                                    const isSat = day.getDay() === 6;
                                                    const hasUnfilled = stats.unfilledDays?.has(dKey);

                                                    let workers = [...s.morning, ...s.night];
                                                    if(enabledShifts.nightShift) workers = [...workers, ...(s.nightShift||[])];
                                                    const offDuty = employees.filter(e => !workers.includes(e.id) && !(s.standby || []).includes(e.id));
                                                    let shiftsToRender = [
                                                        { key: 'morning', start: req.morningStart, end: req.morningEnd, bg: 'bg-amber-100 border-amber-300 text-amber-900' },
                                                        { key: 'night', start: req.nightStart, end: req.nightEnd, bg: 'bg-indigo-100 border-indigo-300 text-indigo-900' } 
                                                    ];
                                                    if(enabledShifts.nightShift) shiftsToRender.push({ key: 'nightShift', start: req.nightShiftStart, end: req.nightShiftEnd, bg: 'bg-purple-100 border-purple-300 text-purple-900' });
                                                    if(enabledShifts.standby) shiftsToRender.push({ key: 'standby', start: null, end: null, bg: 'bg-cyan-100 border-cyan-300 text-cyan-900' });

                                                    // FIX: Add dynamic border width style
                                                    const cellStyle = { borderRightWidth: lineWeight, borderLeftWidth: lineWeight, borderColor: lineColor, borderStyle: 'solid' };

                                                    return (
                                                        <tr key={dKey} className={`group ${hasUnfilled ? 'bg-red-50 hover:bg-red-100' : 'hover:bg-slate-50'} ${isFri ? 'bg-gray-100' : ''} ${isSat ? 'bg-indigo-50/10' : ''}`} style={{ borderBottomWidth: lineWeight, borderColor: lineColor, borderStyle: 'solid' }}>
                                                            {/* FIXED: Date column cells center aligned */}
                                                            <td className="p-3 border-e border-slate-100 align-top text-center" style={{ ...cellStyle, width: '120px', backgroundColor: hasUnfilled ? '#fff1f2' : undefined }}>
                                                                <div className={`font-bold ${hasUnfilled ? 'text-red-900' : 'text-slate-700'}`} style={{ fontSize: `${viewSettings.headerFontSize}px` }}>{formatShortDate(day)}</div>
                                                                <div className={`uppercase ${hasUnfilled ? 'text-red-700' : (isFri ? 'text-red-400 font-bold' : 'text-slate-400')}`} style={{ fontSize: `${Math.max(8, viewSettings.headerFontSize - 2)}px` }}>{getDayName(day)}</div>
                                                            </td>
                                                            {shiftsToRender.map(sh => (
                                                                <td key={sh.key} className={`p-2 border-e border-slate-100 align-top ${hasUnfilled ? 'bg-red-50/60' : ''}`} style={cellStyle}>
                                                                    <div className="flex flex-wrap gap-2 justify-center">
                                                                        {employees.map(emp => {
                                                                            const isSelected = (s[sh.key] || []).includes(emp.id);
                                                                            const isWorking = workers.includes(emp.id);
                                                                            const isOnStandby = (s.standby || []).includes(emp.id);
                                                                            let isBusy = sh.key === 'standby' ? isWorking : (isWorking || isOnStandby);
                                                                            const avail = availability[emp.id]?.[dKey];
                                                                            let disabled = isBusy && !isSelected;
                                                                            if (avail === 'unavailable') disabled = true;
                                                                            if (avail === 'standby_only' && sh.key !== 'standby') disabled = true;
                                                                            if (sh.key === 'morning' && (avail === 'night_only' || avail === 'evening_only')) disabled = true;
                                                                            if (sh.key === 'night' && (avail === 'morning_only' || avail === 'night_only')) disabled = true;
                                                                            if (sh.key === 'nightShift' && (avail === 'morning_only' || avail === 'evening_only')) disabled = true;
                                                                            if (req[sh.key] === 0 && !isSelected) return null;

                                                                            const isHighlighted = highlightedEmp == emp.id;
                                                                            const isDimmed = highlightedEmp && !isHighlighted;
                                                                            let btnClass = isSelected ? sh.bg : 'bg-white border-slate-200 text-slate-500 hover:border-slate-400';
                                                                            if (isHighlighted) btnClass += " ring-2 ring-offset-1 ring-blue-500 font-bold scale-105 z-10 shadow-md";
                                                                            if (isDimmed) btnClass += " opacity-30 blur-[0.5px]";

                                                                            return (
                                                                                <button key={emp.id} disabled={disabled} onClick={() => toggleAssignment(dKey, sh.key, emp.id)}
                                                                                    style={{ fontSize: `${viewSettings.cellFontSize}px` }}
                                                                                    className={`px-2 py-1 rounded border transition-all ${btnClass} ${disabled ? 'opacity-30 cursor-not-allowed bg-slate-50' : ''}`}>
                                                                                    {emp.name}
                                                                                </button>
                                                                            )
                                                                        })}
                                                                    </div>
                                                                    <div className={`mt-1 text-center ${(s[sh.key]||[]).length !== req[sh.key] ? 'text-red-400 font-medium' : 'text-green-500 opacity-50'}`} style={{ fontSize: `${Math.max(8, viewSettings.cellFontSize - 2)}px` }}>{(s[sh.key]||[]).length}/{req[sh.key]}</div>
                                                                </td>
                                                            ))}
                                                            <td className={`p-2 align-top ${hasUnfilled ? 'bg-red-50/60' : 'bg-slate-50/30'}`} style={cellStyle}>
                                                                <div className="flex flex-wrap gap-1.5 mt-2 justify-center">
                                                                    {offDuty.map(emp => {
                                                                        const isHighlighted = highlightedEmp == emp.id;
                                                                        const isDimmed = highlightedEmp && !isHighlighted;
                                                                        let badgeClass = "bg-slate-200 text-slate-500 border-slate-300";
                                                                        if (isHighlighted) badgeClass = "bg-emerald-100 text-emerald-800 border-emerald-300 ring-2 ring-blue-500 font-bold shadow-md scale-105";
                                                                        if (isDimmed) badgeClass += " opacity-20";
                                                                        return ( <span key={emp.id} style={{ fontSize: `${Math.max(8, viewSettings.cellFontSize - 2)}px` }} className={`px-1.5 py-0.5 rounded border ${badgeClass}`}>{emp.name}</span> )
                                                                    })}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    )
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'export_opts' && (
                                <div className="p-10 flex flex-col items-center justify-start text-slate-500 flex-1 overflow-auto custom-scroll w-full">
                                    <div className="mb-6 text-center">
                                        <h3 className="font-bold text-lg text-slate-700">{t('excel_settings_title')}</h3>
                                        <p>{t('excel_settings_desc')}</p>
                                    </div>

                                    <div className="w-full flex flex-col lg:flex-row gap-8 items-start">
                                        <div className="w-full lg:w-1/2 bg-white border border-slate-200 rounded-lg p-6 shadow-sm space-y-6">

                                            <div className="flex justify-end">
                                                <button onClick={resetExcelStyles} className="text-xs text-blue-600 hover:text-blue-800 underline">{t('reset_excel_styles')}</button>
                                            </div>

                                            <div className="grid grid-cols-1 gap-4">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t('office_name')}</label>
                                                    <input type="text" className="w-full border p-2 rounded text-slate-700" value={excelConfig.officeName} onChange={e=>setExcelConfig({...excelConfig, officeName: e.target.value})} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t('prepared_by')}</label>
                                                    <input type="text" className="w-full border p-2 rounded text-slate-700" value={excelConfig.preparedBy} onChange={e=>setExcelConfig({...excelConfig, preparedBy: e.target.value})} />
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t('header_text_color')}</label>
                                                    <div className="flex items-center gap-2">
                                                        <input type="color" className="h-10 w-10 cursor-pointer border rounded" value={excelConfig.headerColor} onChange={e=>setExcelConfig({...excelConfig, headerColor: e.target.value})}/>
                                                        <span className="text-xs text-slate-500">{t('header_text_color')}</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t('text_color')}</label>
                                                    <div className="flex items-center gap-2">
                                                        <input type="color" className="h-10 w-10 cursor-pointer border rounded" value={excelConfig.textColor} onChange={e=>setExcelConfig({...excelConfig, textColor: e.target.value})}/>
                                                        <span className="text-xs text-slate-500">{t('text_color')}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t('font_size_header')} ({excelConfig.headerFontSize}px)</label>
                                                    <input type="range" min="8" max="48" step="1" className="w-full accent-blue-600" value={excelConfig.headerFontSize} onChange={e=>setExcelConfig({...excelConfig, headerFontSize: +e.target.value})} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t('font_size_body')} ({excelConfig.bodyFontSize}px)</label>
                                                    <input type="range" min="8" max="48" step="1" className="w-full accent-blue-600" value={excelConfig.bodyFontSize} onChange={e=>setExcelConfig({...excelConfig, bodyFontSize: +e.target.value})} />
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t('header_weight')}</label>
                                                      <select value={excelConfig.headerFontWeight} onChange={e=>setExcelConfig({...excelConfig, headerFontWeight: e.target.value})} className="w-full text-xs p-2 border rounded">
                                                          <option value="thin">{t('weight_thin')}</option>
                                                          <option value="extra_light">{t('weight_extra_light')}</option>
                                                          <option value="light">{t('weight_light')}</option>
                                                          <option value="normal">{t('weight_normal')}</option>
                                                          <option value="medium">{t('weight_medium')}</option>
                                                          <option value="semibold">{t('weight_semibold')}</option>
                                                          <option value="bold">{t('weight_bold')}</option>
                                                          <option value="extra_bold">{t('weight_extra_bold')}</option>
                                                          <option value="black">{t('weight_black')}</option>
                                                      </select>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t('body_weight')}</label>
                                                      <select value={excelConfig.bodyFontWeight} onChange={e=>setExcelConfig({...excelConfig, bodyFontWeight: e.target.value})} className="w-full text-xs p-2 border rounded">
                                                          <option value="thin">{t('weight_thin')}</option>
                                                          <option value="extra_light">{t('weight_extra_light')}</option>
                                                          <option value="light">{t('weight_light')}</option>
                                                          <option value="normal">{t('weight_normal')}</option>
                                                          <option value="medium">{t('weight_medium')}</option>
                                                          <option value="semibold">{t('weight_semibold')}</option>
                                                          <option value="bold">{t('weight_bold')}</option>
                                                          <option value="extra_bold">{t('weight_extra_bold')}</option>
                                                          <option value="black">{t('weight_black')}</option>
                                                      </select>
                                                </div>
                                            </div>

                                            <div className="flex items-center gap-2 bg-slate-50 p-3 rounded border border-slate-200">
                                                <input
                                                    type="checkbox"
                                                    className="w-4 h-4 text-blue-600 rounded"
                                                    checked={excelConfig.includeShiftDayNames !== false}
                                                    onChange={e=>setExcelConfig({...excelConfig, includeShiftDayNames: e.target.checked})}
                                                />
                                                <span className="text-sm font-medium text-slate-700">{t('include_day_names')}</span>
                                            </div>

                                            <div className="bg-slate-50 border border-slate-200 rounded-lg p-3 space-y-3">
                                                <div className="flex items-center justify-between">
                                                    <label className="block text-xs font-bold text-slate-500 uppercase">{t('excel_border_settings')}</label>
                                                </div>
                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                                    <div>
                                                        <span className="block text-[10px] font-semibold uppercase text-slate-500">{t('border_top')}</span>
                                                        <select className="w-full p-2 border border-slate-300 rounded text-sm" value={excelConfig.frameBorders?.top || 'thin'} onChange={e=>setExcelConfig({...excelConfig, frameBorders: {...excelConfig.frameBorders, top: e.target.value}})}>
                                                            <option value="thin">{t('thin')}</option>
                                                            <option value="medium">{t('medium')}</option>
                                                            <option value="thick">{t('thick')}</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <span className="block text-[10px] font-semibold uppercase text-slate-500">{t('border_right')}</span>
                                                        <select className="w-full p-2 border border-slate-300 rounded text-sm" value={excelConfig.frameBorders?.right || 'thin'} onChange={e=>setExcelConfig({...excelConfig, frameBorders: {...excelConfig.frameBorders, right: e.target.value}})}>
                                                            <option value="thin">{t('thin')}</option>
                                                            <option value="medium">{t('medium')}</option>
                                                            <option value="thick">{t('thick')}</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <span className="block text-[10px] font-semibold uppercase text-slate-500">{t('border_bottom')}</span>
                                                        <select className="w-full p-2 border border-slate-300 rounded text-sm" value={excelConfig.frameBorders?.bottom || 'thin'} onChange={e=>setExcelConfig({...excelConfig, frameBorders: {...excelConfig.frameBorders, bottom: e.target.value}})}>
                                                            <option value="thin">{t('thin')}</option>
                                                            <option value="medium">{t('medium')}</option>
                                                            <option value="thick">{t('thick')}</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <span className="block text-[10px] font-semibold uppercase text-slate-500">{t('border_left')}</span>
                                                        <select className="w-full p-2 border border-slate-300 rounded text-sm" value={excelConfig.frameBorders?.left || 'thin'} onChange={e=>setExcelConfig({...excelConfig, frameBorders: {...excelConfig.frameBorders, left: e.target.value}})}>
                                                            <option value="thin">{t('thin')}</option>
                                                            <option value="medium">{t('medium')}</option>
                                                            <option value="thick">{t('thick')}</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t('line_weight')}</label>
                                                        <select className="w-full p-2 border border-slate-300 rounded text-sm" value={excelConfig.lineWeight} onChange={e=>setExcelConfig({...excelConfig, lineWeight: e.target.value})}>
                                                            <option value="thin">{t('thin')}</option>
                                                            <option value="medium">{t('medium')}</option>
                                                            <option value="thick">{t('thick')}</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t('line_color')}</label>
                                                        <input type="color" className="w-full h-10 border border-slate-300 rounded" value={excelConfig.lineColor || '#e2e8f0'} onChange={e=>setExcelConfig({...excelConfig, lineColor: e.target.value})}/>
                                                    </div>
                                                    <div className="md:col-span-2 flex items-center gap-3">
                                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1">{t('frame_color')}</label>
                                                        <input type="color" className="w-16 h-9 border border-slate-300 rounded" value={excelConfig.frameColor || '#e2e8f0'} onChange={e=>setExcelConfig({...excelConfig, frameColor: e.target.value})}/>
                                                    </div>
                                                </div>
                                            </div>
                                            <hr className="border-slate-100"/>
                                            <div>
                                                <div className="flex justify-between items-center mb-2">
                                                    <label className="block text-xs font-bold text-slate-500 uppercase">{t('header_image')}</label>
                                                    {excelConfig.headerImage && <button onClick={()=>setExcelConfig({...excelConfig, headerImage: null})} className="text-xs text-red-500 hover:text-red-700 underline">{t('remove_image')}</button>}
                                                </div>
                                                <div className="flex gap-4 items-start">
                                                    <div onClick={()=>headerImgRef.current.click()} className="w-20 h-20 bg-slate-50 border border-dashed border-slate-300 rounded hover:bg-slate-100 cursor-pointer flex items-center justify-center overflow-hidden">
                                                        {excelConfig.headerImage ? <img src={excelConfig.headerImage} className="w-full h-full object-cover" /> : <Image size={24} className="text-slate-300"/>}
                                                    </div>
                                                    <div className="flex-1 space-y-2">
                                                        <input type="file" ref={headerImgRef} className="hidden" accept="image/*" onChange={handleHeaderImageUpload}/>
                                                        <button onClick={()=>headerImgRef.current.click()} className="text-xs bg-slate-800 text-white px-3 py-1.5 rounded">{t('upload_image')}</button>
                                                        <div>
                                                            <label className="block text-[10px] font-bold text-slate-400 uppercase mb-1">{t('effect')}</label>
                                                            <select value={excelConfig.headerEffect} onChange={e=>setExcelConfig({...excelConfig, headerEffect: e.target.value})} className="w-full text-xs p-1 border rounded">
                                                                <option value="none">{t('ef_none')}</option>
                                                                <option value="grayscale">{t('ef_gray')}</option>
                                                                <option value="washout">{t('ef_wash')}</option>
                                                                <option value="washout_grayscale">{t('ef_wash_gray')}</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <hr className="border-slate-100"/>
                                            {/* NEW: Footer Image Section */}
                                            <div>
                                                <div className="flex justify-between items-center mb-2">
                                                    <label className="block text-xs font-bold text-slate-500 uppercase">{t('footer_image')}</label>
                                                    {excelConfig.footerImage && <button onClick={()=>setExcelConfig({...excelConfig, footerImage: null})} className="text-xs text-red-500 hover:text-red-700 underline">{t('remove_image')}</button>}
                                                </div>
                                                <div className="flex gap-4 items-start">
                                                    <div onClick={()=>footerImgRef.current.click()} className="w-20 h-20 bg-slate-50 border border-dashed border-slate-300 rounded hover:bg-slate-100 cursor-pointer flex items-center justify-center overflow-hidden">
                                                        {excelConfig.footerImage ? <img src={excelConfig.footerImage} className="w-full h-full object-cover" /> : <Image size={24} className="text-slate-300"/>}
                                                    </div>
                                                    <div className="flex-1 space-y-2">
                                                        <input type="file" ref={footerImgRef} className="hidden" accept="image/*" onChange={handleFooterImageUpload}/>
                                                        <button onClick={()=>footerImgRef.current.click()} className="text-xs bg-slate-800 text-white px-3 py-1.5 rounded">{t('upload_image')}</button>
                                                        <div>
                                                            <label className="block text-[10px] font-bold text-slate-400 uppercase mb-1">{t('effect')}</label>
                                                            <select value={excelConfig.footerEffect} onChange={e=>setExcelConfig({...excelConfig, footerEffect: e.target.value})} className="w-full text-xs p-1 border rounded">
                                                                <option value="none">{t('ef_none')}</option>
                                                                <option value="grayscale">{t('ef_gray')}</option>
                                                                <option value="washout">{t('ef_wash')}</option>
                                                                <option value="washout_grayscale">{t('ef_wash_gray')}</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <hr className="border-slate-100"/>
                                            <div>
                                                <div className="flex justify-between items-center mb-2">
                                                    <label className="block text-xs font-bold text-slate-500 uppercase">{t('watermark_image')}</label>
                                                    {excelConfig.watermarkImage && <button onClick={()=>setExcelConfig({...excelConfig, watermarkImage: null})} className="text-xs text-red-500 hover:text-red-700 underline">{t('remove_image')}</button>}
                                                </div>
                                                <div className="flex gap-4 items-start">
                                                    <div onClick={()=>watermarkImgRef.current.click()} className="w-20 h-20 bg-slate-50 border border-dashed border-slate-300 rounded hover:bg-slate-100 cursor-pointer flex items-center justify-center overflow-hidden">
                                                        {excelConfig.watermarkImage ? <img src={excelConfig.watermarkImage} className="w-full h-full object-cover" /> : <Shield size={24} className="text-slate-300"/>}
                                                    </div>
                                                    <div className="flex-1 space-y-2">
                                                        <input type="file" ref={watermarkImgRef} className="hidden" accept="image/*" onChange={handleWatermarkImageUpload}/>
                                                        <button onClick={()=>watermarkImgRef.current.click()} className="text-xs bg-slate-800 text-white px-3 py-1.5 rounded">{t('upload_image')}</button>
                                                          <div>
                                                              <label className="block text-[10px] font-bold text-slate-400 uppercase mb-1">{t('effect')}</label>
                                                              <select value={excelConfig.watermarkEffect} onChange={e=>setExcelConfig({...excelConfig, watermarkEffect: e.target.value})} className="w-full text-xs p-1 border rounded">
                                                                  <option value="washout">{t('ef_wash')}</option>
                                                                  <option value="washout_grayscale">{t('ef_wash_gray')}</option>
                                                              </select>
                                                          </div>
                                                          <div>
                                                              <label className="block text-[10px] font-bold text-slate-400 uppercase mb-1">{t('watermark_opacity')} ({Math.round((excelConfig.watermarkOpacity ?? 0.35) * 100)}%)</label>
                                                              <input type="range" min="5" max="100" step="5" className="w-full accent-blue-600" value={Math.round((excelConfig.watermarkOpacity ?? 0.35) * 100)} onChange={e=>setExcelConfig({...excelConfig, watermarkOpacity: Math.round(+e.target.value)/100})} />
                                                          </div>
                                                          <span className="text-[10px] text-slate-400">{t('watermark_hint')}</span>
                                                      </div>
                                                  </div>
                                              </div>
                                            <hr className="border-slate-100"/>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">{t('cell_colors')}</label>
                                                <div className="grid grid-cols-2 gap-4 mb-3 p-3 bg-slate-50 rounded border border-slate-100">
                                                    <div className="flex items-center gap-2">
                                                        <input type="color" className="h-8 w-8 cursor-pointer border rounded" value={excelConfig.headerRowColor} onChange={e=>setExcelConfig({...excelConfig, headerRowColor: e.target.value})}/>
                                                        <span className="text-xs font-bold text-slate-700">{t('header_row_color')}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <input type="color" className="h-8 w-8 cursor-pointer border rounded" value={excelConfig.dateColumnColor} onChange={e=>setExcelConfig({...excelConfig, dateColumnColor: e.target.value})}/>
                                                        <span className="text-xs font-bold text-slate-700">{t('date_col_color')}</span>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-3 gap-x-2 gap-y-3">
                                                    <div className="flex items-center gap-2">
                                                        <input type="color" className="h-6 w-6 cursor-pointer border rounded" value={excelConfig.mornCellColor} onChange={e=>setExcelConfig({...excelConfig, mornCellColor: e.target.value})}/>
                                                        <span className="text-xs font-medium text-slate-600">{t('morn_cell_color')}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <input type="color" className="h-6 w-6 cursor-pointer border rounded" value={excelConfig.eveCellColor} onChange={e=>setExcelConfig({...excelConfig, eveCellColor: e.target.value})}/>
                                                        <span className="text-xs font-medium text-slate-600">{t('eve_cell_color')}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <input type="color" className="h-6 w-6 cursor-pointer border rounded" value={excelConfig.nightCellColor} onChange={e=>setExcelConfig({...excelConfig, nightCellColor: e.target.value})}/>
                                                        <span className="text-xs font-medium text-slate-600">{t('night_cell_color')}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <input type="color" className="h-6 w-6 cursor-pointer border rounded" value={excelConfig.standbyCellColor} onChange={e=>setExcelConfig({...excelConfig, standbyCellColor: e.target.value})}/>
                                                        <span className="text-xs font-medium text-slate-600">{t('standby_cell_color')}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <input type="color" className="h-6 w-6 cursor-pointer border rounded" value={excelConfig.offCellColor} onChange={e=>setExcelConfig({...excelConfig, offCellColor: e.target.value})}/>
                                                        <span className="text-xs font-medium text-slate-600">{t('off_cell_color')}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="w-full lg:w-1/2 flex flex-col items-center">
                                            <div className="mb-2 text-xs font-bold text-slate-400 uppercase tracking-widest">{t('preview_mode')}</div>
                                            <PreviewSection />
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'availability' && (
                                <div className="flex flex-col h-full bg-slate-50/50">
                                    <div className="p-6 border-b border-slate-200 bg-white">
                                        <h2 className="text-xl font-bold text-slate-800">{t('avail_title')}</h2>
                                        <p className="text-sm text-slate-500 mt-1">{t('avail_desc')}</p>
                                    </div>
                                    <div className="flex-1 overflow-x-auto custom-scroll p-6 space-y-6">
                                        <div className="bg-white rounded-lg shadow-sm border border-slate-200 inline-block min-w-full">
                                            <table className="w-full text-sm">
                                                <thead>
                                                    <tr className="bg-slate-50 border-b border-slate-200">
                                                        <th className="p-3 text-start font-bold text-slate-600 w-32 sticky start-0 bg-slate-50 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] rtl:shadow-[-2px_0_5px_-2px_rgba(0,0,0,0.1)]">{t('emp_col')}</th>
                                                        {employees.map(e => ( <th key={e.id} className="p-3 text-center border-s border-slate-100 min-w-[140px]"><div className="font-bold text-slate-800 text-base">{e.name}</div></th> ))}
                                                    </tr>
                                                    <tr className="bg-slate-50/30 border-b border-slate-200">
                                                        <th className="p-3 text-start text-xs text-slate-500 align-middle sticky start-0 bg-white z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] rtl:shadow-[-2px_0_5px_-2px_rgba(0,0,0,0.1)]"><span className="font-semibold block">{t('pref_row')}</span></th>
                                                        {employees.map(e => (
                                                            <td key={e.id} className="p-2 border-s border-slate-100 text-center">
                                                                <div className="inline-flex bg-slate-100 rounded-lg p-1">
                                                                    <button onClick={()=>setPreferences(p=>({...p,[e.id]:'neutral'}))} className={`p-1.5 rounded ${!preferences[e.id] || preferences[e.id]==='neutral' ? 'bg-white shadow text-slate-800' : 'text-slate-400'}`}><Users size={14}/></button>
                                                                    <button onClick={()=>setPreferences(p=>({...p,[e.id]:'morning'}))} className={`p-1.5 rounded ${preferences[e.id]==='morning' ? 'bg-amber-100 text-amber-700 shadow-sm' : 'text-slate-400'}`}><Sun size={14}/></button>
                                                                    <button onClick={()=>setPreferences(p=>({...p,[e.id]:'night'}))} className={`p-1.5 rounded ${preferences[e.id]==='night' ? 'bg-indigo-100 text-indigo-700 shadow-sm' : 'text-slate-400'}`}><Moon size={14}/></button>
                                                                </div>
                                                            </td>
                                                        ))}
                                                    </tr>
                                                    <tr className="bg-indigo-50/20 border-b-2 border-indigo-100">
                                                        <th className="p-3 text-start text-xs text-indigo-600 align-middle sticky start-0 bg-indigo-50/20 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] rtl:shadow-[-2px_0_5px_-2px_rgba(0,0,0,0.1)]"><span className="font-bold block flex items-center gap-1"><ArrowDownCircle size={14}/> {t('bulk_row')}</span></th>
                                                        {employees.map(e => (
                                                            <td key={e.id} className="p-2 border-s border-slate-100 text-center">
                                                                <select className="w-full text-xs p-1.5 rounded border border-indigo-200 bg-white text-slate-700 focus:ring-2 focus:ring-indigo-500" value={bulkSelectState[e.id] || "select_action"} onChange={(ev) => handleBulkAvailability(e.id, ev.target.value)}>
                                                                    <option value="select_action" disabled>{t('action_ph')}</option>
                                                                    <option value="">{t('set_avail')}</option>
                                                                    <option value="unavailable">{t('set_unavail')}</option>
                                                                    <option value="morning_only">{t('set_morn')}</option>
                                                                    <option value="evening_only">{t('set_eve')}</option>
                                                                    {enabledShifts.nightShift && <option value="night_only">{t('set_night')}</option>}
                                                                    {enabledShifts.standby && <option value="standby_only">{t('set_standby')}</option>}
                                                                    <option value="priority_day_0" className="font-bold bg-indigo-50">{t('set_sun')}</option>
                                                                    <option value="priority_day_1" className="font-bold bg-indigo-50">{t('set_mon')}</option>
                                                                    <option value="priority_day_2" className="font-bold bg-indigo-50">{t('set_tue')}</option>
                                                                    <option value="priority_day_3" className="font-bold bg-indigo-50">{t('set_wed')}</option>
                                                                    <option value="priority_day_4" className="font-bold bg-indigo-50">{t('set_thu')}</option>
                                                                    <option value="priority_day_5" className="font-bold bg-indigo-50">{t('set_fri')}</option>
                                                                    <option value="priority_day_6" className="font-bold bg-indigo-50">{t('set_sat')}</option>
                                                                </select>
                                                            </td>
                                                        ))}
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {getCalculatedDays().map(day => {
                                                        const dKey = formatDateKey(day);
                                                        const isFri = day.getDay() === 5;
                                                        const isSat = day.getDay() === 6;
                                                        return (
                                                            <tr key={dKey} className={`hover:bg-slate-50 ${isFri ? 'bg-gray-100' : ''} ${isSat ? 'bg-indigo-50/10' : ''}`}>
                                                                <td className="p-2 ps-3 font-medium text-slate-600 border-e border-slate-100 bg-white sticky start-0 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] rtl:shadow-[-2px_0_5px_-2px_rgba(0,0,0,0.1)]">{formatShortDate(day)} <span className={`text-[10px] uppercase ${isFri ? 'text-red-400 font-bold' : 'text-slate-400'} ms-1`}>{getDayName(day)}</span></td>
                                                                {employees.map(e => {
                                                                    const status = availability[e.id]?.[dKey];
                                                                    let cellClass = "";
                                                                    if(status === 'unavailable') cellClass = "bg-red-50";
                                                                    if(status === 'morning_only') cellClass = "bg-amber-50";
                                                                    if(status === 'evening_only') cellClass = "bg-blue-50";
                                                                    if(status === 'night_only' && enabledShifts.nightShift) cellClass = "bg-indigo-50";
                                                                    if(status === 'standby_only' && enabledShifts.standby) cellClass = "bg-emerald-50";
                                                                    if(status === 'priority') cellClass = "bg-indigo-100 ring-2 ring-indigo-300 ring-inset";

                                                                    return (
                                                                        <td key={e.id} className={`p-1 border-s border-slate-100 ${cellClass}`}>
                                                                            <select value={status || ''} onChange={(ev) => setAvailability(prev => { const newVal = ev.target.value; const newAvail = { ...prev }; if(!newAvail[e.id]) newAvail[e.id] = {}; if(newVal === '') delete newAvail[e.id][dKey]; else newAvail[e.id][dKey] = newVal; return newAvail; })} className="w-full bg-transparent text-xs p-1 border-none focus:ring-0 text-center cursor-pointer font-medium text-slate-600">
                                                                                <option value="">-</option>
                                                                                <option value="unavailable">{t('opt_unavail')}</option>
                                                                                <option value="morning_only">{t('opt_morn')}</option>
                                                                                <option value="evening_only">{t('opt_eve')}</option>
                                                                                {enabledShifts.nightShift && <option value="night_only">{t('opt_night')}</option>}
                                                                                {enabledShifts.standby && <option value="standby_only">{t('opt_standby')}</option>}
                                                                                <option value="priority">{t('opt_priority')}</option>
                                                                            </select>
                                                                        </td>
                                                                    )
                                                                })}
                                                            </tr>
                                                        )
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div className="grid gap-4 md:grid-cols-2">
                                            <div className="bg-white rounded-lg border border-slate-200 shadow-sm p-4">
                                                <div className="flex items-center gap-2 text-slate-800 font-semibold mb-1"><Info size={16}/> {t('rules_title')}</div>
                                                <p className="text-xs text-slate-500 mb-3">{t('rules_desc')}</p>
                                                <ul className="space-y-2 text-sm text-slate-700">
                                                    {(() => {
                                                        const ruleItems = [t('rule_single_shift'), t('rule_unavailable'), t('rule_morning_only'), t('rule_evening_only')];
                                                        if (enabledShifts.nightShift) ruleItems.push(t('rule_night_only'));
                                                        if (enabledShifts.standby) ruleItems.push(t('rule_standby_only'));
                                                        ruleItems.push(t('rule_priority'));
                                                        if (enabledShifts.standby) ruleItems.push(t('rule_standby'));
                                                        return ruleItems.map((item, idx) => (
                                                            <li key={idx} className="flex items-start gap-2">
                                                                <span className="w-1.5 h-1.5 mt-1.5 rounded-full bg-indigo-500"></span>
                                                                <span>{item}</span>
                                                            </li>
                                                        ));
                                                    })()}
                                                </ul>
                                            </div>
                                            <div className="bg-white rounded-lg border border-amber-200 shadow-sm p-4">
                                                <div className="flex items-center gap-2 text-amber-800 font-semibold mb-1"><AlertTriangle size={16}/> {t('warning_rules_title')}</div>
                                                <p className="text-xs text-slate-500 mb-3">{t('warning_rules_desc')}</p>
                                                <ul className="space-y-2 text-sm text-slate-700">
                                                    {(() => {
                                                        const warningItems = [t('warning_unfilled'), t('warning_imbalance'), t('warning_three_day'), t('warning_violation_streak'), t('warning_violation_rest')];
                                                        return warningItems.map((item, idx) => (
                                                            <li key={idx} className="flex items-start gap-2">
                                                                <span className="w-1.5 h-1.5 mt-1.5 rounded-full bg-amber-500"></span>
                                                                <span>{item}</span>
                                                            </li>
                                                        ));
                                                    })()}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {(activeTab === 'employees' || activeTab === 'settings') && (
                                <div className="p-10 flex flex-col items-center justify-start text-slate-500 flex-1 overflow-auto custom-scroll">
                                    <div className="mb-6 text-center">
                                        <Info size={48} className="mx-auto mb-2 opacity-50"/>
                                        <p>{activeTab === 'employees' ? t('manage_staff') : t('settings_desc')}</p>
                                    </div>
                                    
                                    {activeTab === 'employees' && (
                                        <div className="w-full max-w-md space-y-2">
                                            {employees.map((e, i) => (
                                                <div key={e.id} className="flex gap-2">
                                                    <input className="flex-1 border p-2 rounded text-slate-700" value={e.name} onChange={ev=>{ const n = [...employees]; n[i].name=ev.target.value; setEmployees(n); }}/>
                                                    <button onClick={()=>setEmployees(employees.filter(x=>x.id!==e.id))} className="text-red-500 p-2 hover:bg-red-50 rounded"><Trash2 size={18}/></button>
                                                </div>
                                            ))}
                                            <button onClick={()=>setEmployees([...employees, {id:Date.now(), name:'New Staff'}])} className="w-full bg-slate-800 hover:bg-slate-700 text-white p-2 rounded mt-2">{t('add_staff')}</button>
                                        </div>
                                    )}
                                    
                                    {activeTab === 'settings' && (
                                        <div className="w-full max-w-3xl flex flex-col gap-6 pb-12">
                                            {/* NEW: VIEW SETTINGS */}
                                            <div className="bg-white border border-slate-200 rounded-lg p-4 shadow-sm">
                                                <div className="flex items-start justify-between gap-2">
                                                    <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2"><Sliders size={18} className="text-blue-500"/> {t('view_settings')}</h3>
                                                    <button onClick={resetViewStyles} className="text-xs text-blue-600 hover:text-blue-800 underline mt-1">{t('reset_view_styles')}</button>
                                                </div>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t('text_size_header')} ({viewSettings.headerFontSize}px)</label>
                                                        <input type="range" min="8" max="24" step="1" className="w-full accent-blue-600" value={viewSettings.headerFontSize} onChange={e=>setViewSettings({...viewSettings, headerFontSize: +e.target.value})} />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t('text_size_cell')} ({viewSettings.cellFontSize}px)</label>
                                                        <input type="range" min="8" max="20" step="1" className="w-full accent-blue-600" value={viewSettings.cellFontSize} onChange={e=>setViewSettings({...viewSettings, cellFontSize: +e.target.value})} />
                                                    </div>
                                                    <div className="md:col-span-2 space-y-2">
                                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t('frame_border')}</label>
                                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                                            <div>
                                                                <span className="block text-[10px] font-semibold uppercase text-slate-500">{t('border_top')}</span>
                                                                <select className="w-full p-2 border border-slate-300 rounded text-sm" value={viewSettings.frameBorders?.top || '1px'} onChange={e=>setViewSettings({...viewSettings, frameBorders: {...viewSettings.frameBorders, top: e.target.value}})}>
                                                                    <option value="1px">{t('thin')}</option>
                                                                    <option value="2px">{t('medium')}</option>
                                                                    <option value="3px">{t('thick')}</option>
                                                                </select>
                                                            </div>
                                                            <div>
                                                                <span className="block text-[10px] font-semibold uppercase text-slate-500">{t('border_right')}</span>
                                                                <select className="w-full p-2 border border-slate-300 rounded text-sm" value={viewSettings.frameBorders?.right || '1px'} onChange={e=>setViewSettings({...viewSettings, frameBorders: {...viewSettings.frameBorders, right: e.target.value}})}>
                                                                    <option value="1px">{t('thin')}</option>
                                                                    <option value="2px">{t('medium')}</option>
                                                                    <option value="3px">{t('thick')}</option>
                                                                </select>
                                                            </div>
                                                            <div>
                                                                <span className="block text-[10px] font-semibold uppercase text-slate-500">{t('border_bottom')}</span>
                                                                <select className="w-full p-2 border border-slate-300 rounded text-sm" value={viewSettings.frameBorders?.bottom || '1px'} onChange={e=>setViewSettings({...viewSettings, frameBorders: {...viewSettings.frameBorders, bottom: e.target.value}})}>
                                                                    <option value="1px">{t('thin')}</option>
                                                                    <option value="2px">{t('medium')}</option>
                                                                    <option value="3px">{t('thick')}</option>
                                                                </select>
                                                            </div>
                                                            <div>
                                                                <span className="block text-[10px] font-semibold uppercase text-slate-500">{t('border_left')}</span>
                                                                <select className="w-full p-2 border border-slate-300 rounded text-sm" value={viewSettings.frameBorders?.left || '1px'} onChange={e=>setViewSettings({...viewSettings, frameBorders: {...viewSettings.frameBorders, left: e.target.value}})}>
                                                                    <option value="1px">{t('thin')}</option>
                                                                    <option value="2px">{t('medium')}</option>
                                                                    <option value="3px">{t('thick')}</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center gap-3">
                                                            <label className="text-xs font-bold text-slate-500 uppercase">{t('frame_color')}</label>
                                                            <input type="color" className="w-16 h-9 border border-slate-300 rounded" value={viewSettings.frameColor || '#e2e8f0'} onChange={e=>setViewSettings({...viewSettings, frameColor: e.target.value})} />
                                                        </div>
                                                    </div>
                                                    <div className="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-3">
                                                        <div>
                                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t('line_weight')}</label>
                                                            <select className="w-full p-2 border border-slate-300 rounded text-sm" value={viewSettings.lineWeight} onChange={e=>setViewSettings({...viewSettings, lineWeight: e.target.value})}>
                                                                <option value="1px">{t('thin')}</option>
                                                                <option value="2px">{t('medium')}</option>
                                                                <option value="3px">{t('thick')}</option>
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t('line_color')}</label>
                                                            <input type="color" className="w-full h-10 border border-slate-300 rounded" value={viewSettings.lineColor || '#e2e8f0'} onChange={e=>setViewSettings({...viewSettings, lineColor: e.target.value})} />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="bg-white border border-slate-200 rounded-lg p-4 shadow-sm">
                                                <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2"><Zap size={18} className="text-amber-500"/> {t('enable_shifts')}</h3>
                                                <div className="flex gap-6">
                                                    <label className="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" checked={enabledShifts.nightShift} onChange={e => handleToggleOptionalShift('nightShift', e.target.checked)} className="w-4 h-4 text-indigo-600 rounded" />
                                                        <span className="text-sm font-medium text-slate-700">{t('enable_night')}</span>
                                                    </label>
                                                    <label className="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" checked={enabledShifts.standby} onChange={e => handleToggleOptionalShift('standby', e.target.checked)} className="w-4 h-4 text-indigo-600 rounded" />
                                                        <span className="text-sm font-medium text-slate-700">{t('enable_standby')}</span>
                                                    </label>
                                                </div>
                                            </div>

                                            <div className="bg-white border border-slate-200 rounded-lg p-4 shadow-sm">
                                                 <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2"><EyeOff size={18} className="text-indigo-500"/> {t('show_times')}</h3>
                                                 <label className="flex items-center gap-2 cursor-pointer bg-slate-50 p-2 rounded border border-slate-200 hover:bg-slate-100 transition-colors">
                                                    <input type="checkbox" checked={showShiftTimes} onChange={e=>setShowShiftTimes(e.target.checked)} className="w-4 h-4 text-indigo-500 rounded focus:ring-indigo-500" />
                                                    <span className="text-sm font-medium text-slate-700">{showShiftTimes ? 'Visible' : 'Hidden'}</span>
                                                </label>
                                            </div>

                                            <div className="bg-indigo-50 border border-indigo-100 rounded-lg p-4">
                                                <h3 className="font-bold text-indigo-900 mb-1 flex items-center gap-2"><Layers size={18}/> {t('bulk_time_title')}</h3>
                                                <p className="text-xs text-indigo-700 mb-3">{t('bulk_time_desc')}</p>
                                                <div className="flex flex-wrap gap-4 items-end">
                                                    <div className="flex flex-col gap-1">
                                                        <span className="text-[10px] uppercase font-bold text-indigo-400">{t('morn')}</span>
                                                        <div className="flex items-center gap-1">
                                                            <input type="time" value={bulkMStart} onChange={e=>setBulkMStart(e.target.value)} className="text-xs p-1 rounded border border-indigo-200" />
                                                            <span>-</span>
                                                            <input type="time" value={bulkMEnd} onChange={e=>setBulkMEnd(e.target.value)} className="text-xs p-1 rounded border border-indigo-200" />
                                                        </div>
                                                    </div>
                                                    <div className="flex flex-col gap-1">
                                                        <span className="text-[10px] uppercase font-bold text-indigo-400">{t('eve')}</span>
                                                        <div className="flex items-center gap-1">
                                                            <input type="time" value={bulkNStart} onChange={e=>setBulkNStart(e.target.value)} className="text-xs p-1 rounded border border-indigo-200" />
                                                            <span>-</span>
                                                            <input type="time" value={bulkNEnd} onChange={e=>setBulkNEnd(e.target.value)} className="text-xs p-1 rounded border border-indigo-200" />
                                                        </div>
                                                    </div>
                                                    {enabledShifts.nightShift && (
                                                        <div className="flex flex-col gap-1">
                                                            <span className="text-[10px] uppercase font-bold text-indigo-400">{t('night')}</span>
                                                            <div className="flex items-center gap-1">
                                                                <input type="time" value={bulkNSStart} onChange={e=>setBulkNSStart(e.target.value)} className="text-xs p-1 rounded border border-indigo-200" />
                                                                <span>-</span>
                                                                <input type="time" value={bulkNSEnd} onChange={e=>setBulkNSEnd(e.target.value)} className="text-xs p-1 rounded border border-indigo-200" />
                                                            </div>
                                                        </div>
                                                    )}
                                                    <button onClick={applyBulkTimes} className="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded text-xs font-medium transition-colors">
                                                        {t('apply_bulk')}
                                                    </button>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                {Object.entries(requirements).map(([dayIdx, req]) => (
                                                    <div key={dayIdx} className="border border-slate-200 rounded-lg bg-white shadow-sm overflow-hidden">
                                                        <div className="bg-slate-50 p-2 border-b border-slate-200 flex justify-between items-center">
                                                            <span className="font-bold text-slate-700 px-2">{TRANSLATIONS[lang].days[dayIdx]}</span>
                                                        </div>
                                                        <div className="p-3 space-y-3">
                                                            <div className="flex flex-col sm:flex-row sm:items-center gap-2 text-sm bg-amber-50/50 p-2 rounded border border-amber-100">
                                                                <span className="w-16 font-semibold text-amber-800 text-xs">{t('morn')}</span>
                                                                <div className="flex flex-col gap-1 w-full">
                                                                    <div className="flex items-center gap-2">
                                                                        <label className="text-[10px] text-slate-400 w-8">{t('count')}</label>
                                                                        <input type="number" min="0" className="w-12 h-6 text-sm border rounded text-center" value={req.morning} onChange={(e)=>setRequirements({...requirements, [dayIdx]: {...req, morning: +e.target.value}})}/>
                                                                    </div>
                                                                    <div className="flex flex-wrap items-center gap-2">
                                                                         <label className="text-[10px] text-slate-400 w-8">{t('start')}</label>
                                                                         <input type="time" className="h-6 text-xs border rounded px-1 min-w-[80px] flex-1" value={req.morningStart} onChange={(e)=>setRequirements({...requirements, [dayIdx]: {...req, morningStart: e.target.value}})}/>
                                                                         <label className="text-[10px] text-slate-400 w-6 text-center">{t('end')}</label>
                                                                         <input type="time" className="h-6 text-xs border rounded px-1 min-w-[80px] flex-1" value={req.morningEnd} onChange={(e)=>setRequirements({...requirements, [dayIdx]: {...req, morningEnd: e.target.value}})}/>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div className="flex flex-col sm:flex-row sm:items-center gap-2 text-sm bg-indigo-50/50 p-2 rounded border border-indigo-100">
                                                                <span className="w-16 font-semibold text-indigo-800 text-xs">{t('eve')}</span>
                                                                <div className="flex flex-col gap-1 w-full">
                                                                    <div className="flex items-center gap-2">
                                                                        <label className="text-[10px] text-slate-400 w-8">{t('count')}</label>
                                                                        <input type="number" min="0" className="w-12 h-6 text-sm border rounded text-center" value={req.night} onChange={(e)=>setRequirements({...requirements, [dayIdx]: {...req, night: +e.target.value}})}/>
                                                                    </div>
                                                                    <div className="flex flex-wrap items-center gap-2">
                                                                         <label className="text-[10px] text-slate-400 w-8">{t('start')}</label>
                                                                         <input type="time" className="h-6 text-xs border rounded px-1 min-w-[80px] flex-1" value={req.nightStart} onChange={(e)=>setRequirements({...requirements, [dayIdx]: {...req, nightStart: e.target.value}})}/>
                                                                         <label className="text-[10px] text-slate-400 w-6 text-center">{t('end')}</label>
                                                                         <input type="time" className="h-6 text-xs border rounded px-1 min-w-[80px] flex-1" value={req.nightEnd} onChange={(e)=>setRequirements({...requirements, [dayIdx]: {...req, nightEnd: e.target.value}})}/>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            {enabledShifts.nightShift && (
                                                                <div className="flex flex-col sm:flex-row sm:items-center gap-2 text-sm bg-purple-50/50 p-2 rounded border border-purple-100">
                                                                    <span className="w-16 font-semibold text-purple-800 text-xs">{t('night')}</span>
                                                                    <div className="flex flex-col gap-1 w-full">
                                                                        <div className="flex items-center gap-2">
                                                                            <label className="text-[10px] text-slate-400 w-8">{t('count')}</label>
                                                                            <input type="number" min="0" className="w-12 h-6 text-sm border rounded text-center" value={req.nightShift} onChange={(e)=>setRequirements({...requirements, [dayIdx]: {...req, nightShift: +e.target.value}})}/>
                                                                        </div>
                                                                        <div className="flex flex-wrap items-center gap-2">
                                                                            <label className="text-[10px] text-slate-400 w-8">{t('start')}</label>
                                                                            <input type="time" className="h-6 text-xs border rounded px-1 min-w-[80px] flex-1" value={req.nightShiftStart} onChange={(e)=>setRequirements({...requirements, [dayIdx]: {...req, nightShiftStart: e.target.value}})}/>
                                                                            <label className="text-[10px] text-slate-400 w-6 text-center">{t('end')}</label>
                                                                            <input type="time" className="h-6 text-xs border rounded px-1 min-w-[80px] flex-1" value={req.nightShiftEnd} onChange={(e)=>setRequirements({...requirements, [dayIdx]: {...req, nightShiftEnd: e.target.value}})}/>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {enabledShifts.standby && (
                                                                <div className="flex flex-col sm:flex-row sm:items-center gap-2 text-sm bg-cyan-50/50 p-2 rounded border border-cyan-100">
                                                                    <span className="w-16 font-semibold text-cyan-800 text-xs">{t('standby')}</span>
                                                                    <div className="flex flex-col gap-1 w-full">
                                                                        <div className="flex items-center gap-2">
                                                                            <label className="text-[10px] text-slate-400 w-8">{t('count')}</label>
                                                                            <input type="number" min="0" className="w-12 h-6 text-sm border rounded text-center" value={req.standby} onChange={(e)=>setRequirements({...requirements, [dayIdx]: {...req, standby: +e.target.value}})}/>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ShiftScheduler />);
    </script>
</body>
</html>
